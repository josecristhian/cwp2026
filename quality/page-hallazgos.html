<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hallazgos ‚Üí Insights ‚Üí Acciones</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ‚ïê‚ïê‚ïê CUSTOM STYLES FOR H‚ÜíI‚ÜíA PAGE ‚ïê‚ïê‚ïê */
        :root {
            --hia-bg: #f0f4f8;
            --hia-card: #ffffff;
            --hia-border: #e2e8f0;
            --hia-text: #1e293b;
            --hia-text-sec: #64748b;
            --hia-blue: #3b82f6;
            --hia-blue-light: #eff6ff;
            --hia-green: #10b981;
            --hia-green-light: #ecfdf5;
            --hia-yellow: #f59e0b;
            --hia-yellow-light: #fffbeb;
            --hia-red: #ef4444;
            --hia-red-light: #fef2f2;
            --hia-orange: #f97316;
            --hia-purple: #8b5cf6;
            --hia-purple-light: #f5f3ff;
            --hia-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
            --hia-shadow-md: 0 4px 6px -1px rgba(0,0,0,0.08), 0 2px 4px -2px rgba(0,0,0,0.04);
            --hia-radius: 12px;
        }

        .hia-container { padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color: var(--hia-text); }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .hia-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 50%, #3b82f6 100%);
            border-radius: var(--hia-radius);
            padding: 32px;
            color: white;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }
        .hia-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
            border-radius: 50%;
        }
        .hia-header h2 { margin: 0 0 8px; font-size: 26px; font-weight: 700; position: relative; }
        .hia-header p { margin: 0; opacity: 0.85; font-size: 14px; position: relative; }
        .hia-header .hia-badge-row { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; position: relative; }
        .hia-header .hia-meta-badge {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        /* ‚îÄ‚îÄ Navigation Tabs ‚îÄ‚îÄ */
        .hia-nav {
            display: flex;
            gap: 4px;
            background: var(--hia-card);
            border-radius: var(--hia-radius);
            padding: 6px;
            margin-bottom: 24px;
            box-shadow: var(--hia-shadow);
            overflow-x: auto;
            flex-wrap: nowrap;
        }
        .hia-nav-btn {
            flex: 0 0 auto;
            padding: 10px 18px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--hia-text-sec);
            transition: all 0.2s;
            white-space: nowrap;
        }
        .hia-nav-btn:hover { background: var(--hia-blue-light); color: var(--hia-blue); }
        .hia-nav-btn.active { background: var(--hia-blue); color: white; box-shadow: 0 2px 8px rgba(59,130,246,0.3); }

        /* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
        .hia-section { display: none; animation: hiaFadeIn 0.3s ease; }
        .hia-section.active { display: block; }
        @keyframes hiaFadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .hia-section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .hia-section-title .icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: 18px;
        }

        /* ‚îÄ‚îÄ KPI Cards ‚îÄ‚îÄ */
        .hia-kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .hia-kpi {
            background: var(--hia-card);
            border-radius: var(--hia-radius);
            padding: 20px;
            box-shadow: var(--hia-shadow);
            border-left: 4px solid var(--hia-blue);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .hia-kpi:hover { transform: translateY(-2px); box-shadow: var(--hia-shadow-md); }
        .hia-kpi .label { font-size: 12px; color: var(--hia-text-sec); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .hia-kpi .value { font-size: 28px; font-weight: 800; line-height: 1.1; }
        .hia-kpi .sub { font-size: 12px; color: var(--hia-text-sec); margin-top: 4px; }
        .hia-kpi.green { border-left-color: var(--hia-green); }
        .hia-kpi.yellow { border-left-color: var(--hia-yellow); }
        .hia-kpi.red { border-left-color: var(--hia-red); }
        .hia-kpi.purple { border-left-color: var(--hia-purple); }

        /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
        .hia-card {
            background: var(--hia-card);
            border-radius: var(--hia-radius);
            padding: 24px;
            box-shadow: var(--hia-shadow);
            margin-bottom: 20px;
        }
        .hia-card-title { font-size: 15px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .hia-card-subtitle { font-size: 13px; color: var(--hia-text-sec); margin-bottom: 12px; }

        /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
        .hia-table-wrap { overflow-x: auto; }
        .hia-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
        }
        .hia-table th {
            background: #f8fafc;
            padding: 10px 14px;
            text-align: left;
            font-weight: 600;
            color: var(--hia-text-sec);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--hia-border);
            white-space: nowrap;
        }
        .hia-table td {
            padding: 10px 14px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }
        .hia-table tbody tr:hover { background: #f8fafc; }
        .hia-table .num { text-align: right; font-variant-numeric: tabular-nums; }

        /* ‚îÄ‚îÄ Progress bars ‚îÄ‚îÄ */
        .hia-bar-bg { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .hia-bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }

        /* ‚îÄ‚îÄ Badges ‚îÄ‚îÄ */
        .hia-badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }
        .hia-badge.critica { background: var(--hia-red-light); color: var(--hia-red); }
        .hia-badge.alta { background: var(--hia-yellow-light); color: #b45309; }
        .hia-badge.media { background: var(--hia-blue-light); color: var(--hia-blue); }
        .hia-badge.q1 { background: var(--hia-green-light); color: #047857; }
        .hia-badge.q2 { background: var(--hia-yellow-light); color: #b45309; }
        .hia-badge.q3 { background: #fff7ed; color: var(--hia-orange); }
        .hia-badge.q4 { background: var(--hia-red-light); color: var(--hia-red); }

        /* ‚îÄ‚îÄ Hallazgo Accordion ‚îÄ‚îÄ */
        .hia-hallazgo {
            background: var(--hia-card);
            border-radius: var(--hia-radius);
            box-shadow: var(--hia-shadow);
            margin-bottom: 16px;
            overflow: hidden;
            border: 1px solid var(--hia-border);
        }
        .hia-hallazgo-header {
            padding: 20px 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: background 0.2s;
        }
        .hia-hallazgo-header:hover { background: #f8fafc; }
        .hia-hallazgo-num {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
        }
        .hia-hallazgo-info { flex: 1; min-width: 0; }
        .hia-hallazgo-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
        .hia-hallazgo-meta { font-size: 12px; color: var(--hia-text-sec); display: flex; gap: 12px; flex-wrap: wrap; }
        .hia-hallazgo-arrow { font-size: 18px; color: var(--hia-text-sec); transition: transform 0.3s; flex-shrink: 0; }
        .hia-hallazgo.open .hia-hallazgo-arrow { transform: rotate(180deg); }
        .hia-hallazgo-body { display: none; padding: 0 24px 24px; border-top: 1px solid var(--hia-border); }
        .hia-hallazgo.open .hia-hallazgo-body { display: block; }

        /* ‚îÄ‚îÄ 3-Layer Tabs within hallazgo ‚îÄ‚îÄ */
        .hia-layers { display: flex; gap: 0; margin: 16px 0; border-radius: 8px; overflow: hidden; border: 1px solid var(--hia-border); }
        .hia-layer-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: #f8fafc;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--hia-text-sec);
            transition: all 0.2s;
            text-align: center;
        }
        .hia-layer-btn:not(:last-child) { border-right: 1px solid var(--hia-border); }
        .hia-layer-btn.active-hallazgo { background: #dbeafe; color: var(--hia-blue); }
        .hia-layer-btn.active-insight { background: #fef3c7; color: #b45309; }
        .hia-layer-btn.active-accion { background: #d1fae5; color: #047857; }
        .hia-layer-content { display: none; padding: 16px 0; }
        .hia-layer-content.active { display: block; }

        /* ‚îÄ‚îÄ Insight narrative ‚îÄ‚îÄ */
        .hia-narrative {
            background: var(--hia-yellow-light);
            border-left: 4px solid var(--hia-yellow);
            padding: 16px 20px;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
        }
        .hia-causes { list-style: none; padding: 0; margin: 0; }
        .hia-causes li {
            padding: 8px 0 8px 28px;
            position: relative;
            font-size: 13px;
            border-bottom: 1px solid #f1f5f9;
        }
        .hia-causes li::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 14px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--hia-yellow);
        }

        /* ‚îÄ‚îÄ Action cards ‚îÄ‚îÄ */
        .hia-action {
            border: 1px solid var(--hia-border);
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 12px;
        }
        .hia-action-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .hia-action-title { font-weight: 700; font-size: 14px; }
        .hia-action-obj { font-size: 13px; color: var(--hia-text-sec); margin-bottom: 10px; }
        .hia-tactics { display: grid; gap: 6px; }
        .hia-tactic {
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .hia-tactic::before { content: '‚ñ∏'; color: var(--hia-green); font-weight: 700; flex-shrink: 0; }
        .hia-smart { margin-top: 10px; padding: 10px 14px; background: var(--hia-green-light); border-radius: 8px; font-size: 12px; }

        /* ‚îÄ‚îÄ Roadmap Timeline ‚îÄ‚îÄ */
        .hia-timeline { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        @media (max-width: 768px) { .hia-timeline { grid-template-columns: 1fr; } }
        .hia-timeline-col {
            border-radius: var(--hia-radius);
            padding: 20px;
            position: relative;
        }
        .hia-timeline-col.mes1 { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border: 1px solid #fca5a5; }
        .hia-timeline-col.mes2 { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border: 1px solid #fcd34d; }
        .hia-timeline-col.mes3 { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 1px solid #6ee7b7; }
        .hia-timeline-title { font-weight: 800; font-size: 15px; margin-bottom: 4px; }
        .hia-timeline-period { font-size: 12px; color: var(--hia-text-sec); margin-bottom: 14px; }
        .hia-timeline-item {
            padding: 10px 12px;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 12px;
            line-height: 1.4;
        }
        .hia-timeline-item .sem { font-weight: 700; color: var(--hia-text-sec); font-size: 11px; }
        .hia-timeline-item .resp { color: var(--hia-text-sec); font-size: 11px; margin-top: 2px; }

        /* ‚îÄ‚îÄ Charts ‚îÄ‚îÄ */
        .hia-chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .hia-chart-card {
            background: var(--hia-card);
            border-radius: var(--hia-radius);
            padding: 20px;
            box-shadow: var(--hia-shadow);
        }
        .hia-chart-card .chart-title { font-size: 14px; font-weight: 700; margin-bottom: 14px; }
        .hia-chart-card canvas { max-height: 280px; }

        /* ‚îÄ‚îÄ Grid layouts ‚îÄ‚îÄ */
        .hia-grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px; margin-bottom: 24px; }

        /* ‚îÄ‚îÄ Governance ‚îÄ‚îÄ */
        .hia-gov-card {
            background: var(--hia-card);
            border-radius: var(--hia-radius);
            padding: 20px;
            box-shadow: var(--hia-shadow);
            border-top: 3px solid var(--hia-purple);
        }

        /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
        .hia-loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--hia-text-sec);
        }
        .hia-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--hia-border);
            border-top-color: var(--hia-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ Export button ‚îÄ‚îÄ */
        .hia-export-btn {
            padding: 8px 18px;
            background: var(--hia-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s;
        }
        .hia-export-btn:hover { background: #2563eb; }

        .hia-pill-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    </style>
</head>
<body style="background: transparent; padding: 0;">
    <div class="hia-container" style="padding: 0;">
        <div id="contenidoPrincipal">
            <div class="hia-loading">
                <div class="spinner"></div>
                <div style="font-size: 15px; font-weight: 600;">Cargando an√°lisis...</div>
                <div style="font-size: 13px; margin-top: 6px;">Procesando modelo Hallazgos ‚Üí Insights ‚Üí Acciones</div>
            </div>
        </div>
    </div>

    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONFIG REGLAS DE NEGOCIO (embedded for client-side)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const CONFIG = {
      umbrales: {
        gapCritico: 5,
        errorFrecuente: 25,
        gapSegmento: 15,
        errorFatal: 5,
        scoreRiesgo: 75,
        scoreExcelente: 85,
      },
      criteriosConPuntaje: [
        'Q1','Q2','Q3','Q4','Q5','Q6','Q7','Q8','Q9','Q10',
        'Q11','Q13','Q14','Q16','Q17','Q18','Q19','Q20','Q21','Q22'
      ],
      criteriosFatales: ['Q12', 'Q15'],
      criteriosCriticos: ['Q4', 'Q11', 'Q20'],
      causasRaiz: {
        gap_criterio_Q11: [
          'Gap de conocimiento t√©cnico en resoluci√≥n de problemas',
          'Presi√≥n de AHT limita tiempo de investigaci√≥n',
          'Sistemas lentos dificultan acceso a informaci√≥n',
          'Falta de documentaci√≥n actualizada',
          'Training insuficiente en productos/servicios'
        ],
        gap_criterio_Q20: [
          'Cat√°logo de tipificaci√≥n demasiado complejo (>100 opciones)',
          'Falta de entrenamiento espec√≠fico en tipificaci√≥n',
          'Presi√≥n de tiempo: tipifican apurados al final',
          'Sin validaci√≥n autom√°tica en tiempo real',
          'Feedback llega tarde (d√≠as despu√©s)'
        ],
        gap_criterio_Q4: [
          'Falta de estructura en la conversaci√≥n',
          'No sigue scripts ni gu√≠as de conversaci√≥n',
          'Dificultad para manejar clientes complejos',
          'Presi√≥n de AHT afecta direcci√≥n de la llamada',
          'Falta de coaching en t√©cnicas de control de llamada'
        ],
        gap_criterio_Q17: [
          'Sin protocolo claro de gesti√≥n de hold',
          'Presi√≥n de AHT: evitan cerrar y reabrir',
          'Sistemas lentos obligan a holds largos',
          'No ofrecen alternativas (callback)'
        ],
        gap_criterio_Q19: [
          'No se promueve uso de canales de autogesti√≥n',
          'Desconocimiento de herramientas digitales disponibles',
          'Falta de incentivo por ofrecer autogesti√≥n',
          'Scripts no incluyen oferta de autogesti√≥n'
        ],
        gap_criterio_Q18: [
          'No existe cultura de disculpa corporativa',
          'Falta de empat√≠a ante inconvenientes del cliente',
          'Agentes no identifican momentos para disculparse',
          'Scripts r√≠gidos no incluyen frases de empat√≠a'
        ],
        gap_criterio_generico: [
          'Falta de entrenamiento espec√≠fico en este criterio',
          'Bajo refuerzo en coaching sobre este tema',
          'Proceso no est√° claramente documentado',
          'Feedback insuficiente o tard√≠o'
        ],
        error_fatal_Q12: [
          'Problema no resuelto en primera interacci√≥n',
          'Falla en Q11 (Soluci√≥n) no detectada por agente',
          'Falta de validaci√≥n antes de cerrar',
          'Cliente debe llamar nuevamente por mismo tema'
        ],
        error_fatal_Q15: [
          'No validaci√≥n correcta de identidad',
          'Dar informaci√≥n sensible sin autenticaci√≥n',
          'Desconocimiento de pol√≠ticas de seguridad',
          'Presi√≥n del cliente para saltarse protocolos'
        ],
        brecha_bpo: [
          'Diferencias en procesos de entrenamiento entre BPOs',
          'Herramientas/sistemas diferentes',
          'Calidad de coaching y supervisi√≥n desigual',
          'Gesti√≥n del conocimiento desigual'
        ],
        brecha_canal: [
          'Mayor tiempo de consulta en digital',
          'Presi√≥n de AHT diferente por canal',
          'Perfil de agente distinto por canal',
          'Complejidad de casos distribuida desigualmente'
        ],
        brecha_skill: [
          'Complejidad t√©cnica diferente entre skills',
          'Diferente nivel de entrenamiento',
          'Herramientas de soporte desiguales',
          'Volumen de casos afecta calidad'
        ],
        oportunidad_canal: [
          'Canal digital permite m√°s tiempo de investigaci√≥n',
          'No hay presi√≥n de silencio inc√≥modo',
          'Puede usar knowledge base m√°s f√°cilmente',
          'Casos m√°s simples van a digital'
        ],
        oportunidad_segmento: [
          'Mejores pr√°cticas identificables',
          'Modelo de coaching replicable',
          'Herramientas m√°s efectivas en uso',
          'Cultura de calidad m√°s madura en ese segmento'
        ]
      },
      impactoPorIndicador: {
        NPS: 'Afecta satisfacci√≥n del cliente y Net Promoter Score',
        AHT: 'Impacta tiempo promedio de atenci√≥n y costos operativos',
        FCR: 'Reduce resoluci√≥n en primer contacto, genera recontactos',
        Ventas: 'Afecta conversi√≥n y revenue',
        Negocio: 'Impacta m√©tricas de negocio y reporter√≠a',
        Compliance: 'Riesgo de incumplimiento normativo',
        Legal: 'Riesgo legal y reputacional'
      },
      accionesPorTipo: {
        gap_criterio: [
          {
            prioridad: 'CRITICA',
            titulo: 'Certificaci√≥n obligatoria en {{criterio_desc}}',
            objetivo: 'Reducir errores de {{pct_error}}% a <{{meta_critica}}% en 60 d√≠as',
            tacticas: [
              'Crear m√≥dulo e-learning espec√≠fico para {{criterio_desc}}',
              'Quiz de certificaci√≥n: m√≠nimo 90% para aprobar',
              'Recertificaci√≥n trimestral obligatoria',
              'Dashboard de certificaci√≥n por supervisor'
            ],
            meta_smart: '100% de agentes certificados en {{criterio_desc}} en 30 d√≠as',
            metrica: '% de agentes certificados, % aprobaci√≥n quiz'
          },
          {
            prioridad: 'ALTA',
            titulo: 'Programa de mentor√≠a para {{criterio_desc}}',
            objetivo: 'Replicar mejores pr√°cticas de agentes top en {{criterio_desc}}',
            tacticas: [
              'Identificar top 20 agentes con {{criterio}}=m√°ximo',
              'Asignar 5 agentes mentoreados por campe√≥n',
              'Sesiones semanales de 30 min por 6 semanas',
              'Reconocimiento a campeones con incentivos'
            ],
            meta_smart: '60% de mentoreados mejoran en >3 puntos en {{criterio_desc}}',
            metrica: 'Delta de {{criterio}} pre vs post mentor√≠a'
          }
        ],
        error_frecuente: [
          {
            prioridad: 'CRITICA',
            titulo: 'Simplificaci√≥n y validaci√≥n autom√°tica para {{criterio_desc}}',
            objetivo: 'Prevenir errores de {{criterio_desc}} mediante controles en tiempo real',
            tacticas: [
              'Simplificar proceso/cat√°logo de {{criterio_desc}}',
              'Implementar validaciones autom√°ticas en sistema',
              'Alertas en tiempo real al agente cuando comete error',
              'Bloquear acciones incorrectas antes de finalizar'
            ],
            meta_smart: 'Sistema activo en 45 d√≠as, previene >70% de errores de {{criterio_desc}}',
            metrica: '% de alertas que evitan errores, % error post-implementaci√≥n'
          }
        ],
        brecha_segmento: [
          {
            prioridad: 'CRITICA',
            titulo: 'Benchmark y replicaci√≥n: {{segmento_mejor}} ‚Üí {{segmento_peor}}',
            objetivo: 'Reducir gap entre {{segmento_mejor}} ({{score_mejor}}) y {{segmento_peor}} ({{score_peor}}) de {{gap}} a <15 puntos',
            tacticas: [
              'Benchmark urgente: identificar 5 mejores pr√°cticas de {{segmento_mejor}}',
              'Shadowing: supervisores de {{segmento_peor}} observan a top performers',
              'Implementar herramientas/procesos del segmento l√≠der',
              'Coaching intensivo para {{segmento_peor}} durante 60 d√≠as'
            ],
            meta_smart: 'Gap reducido en 50% en 60 d√≠as (de {{gap}} a <{{meta_gap}} pts)',
            metrica: 'Score promedio por segmento, delta semanal'
          }
        ],
        error_fatal: [
          {
            prioridad: 'CRITICA',
            titulo: 'Protocolo 3 strikes para errores fatales ({{criterio_desc}})',
            objetivo: 'Reducir errores fatales de {{pct_error}}% a <5% en 90 d√≠as',
            tacticas: [
              'Strike 1: Coaching inmediato + warning escrita',
              'Strike 2: Fuera de operaci√≥n 3 d√≠as para re-training',
              'Strike 3: Plan de mejora 30 d√≠as o desvinculaci√≥n',
              'Comunicar pol√≠tica a toda la operaci√≥n',
              'Dashboard semanal de agentes en strikes'
            ],
            meta_smart: '<5% errores fatales en 90 d√≠as',
            metrica: '% errores fatales, # agentes por strike'
          },
          {
            prioridad: 'CRITICA',
            titulo: 'Intervenci√≥n de emergencia - Agentes con score=0',
            objetivo: '0 agentes operando con score=0 en 2 semanas',
            tacticas: [
              'Identificar agentes con errores fatales recurrentes',
              'Reuni√≥n 1:1 agente + supervisor + RRHH',
              'Plan de mejora intensivo o reasignaci√≥n inmediata',
              'No pueden operar hasta superar recertificaci√≥n'
            ],
            meta_smart: '100% agentes score=0 fuera de operaci√≥n en 7 d√≠as',
            metrica: 'N√∫mero de agentes score=0 operando'
          }
        ],
        oportunidad: [
          {
            prioridad: 'ALTA',
            titulo: 'Estrategia de replicaci√≥n desde {{segmento_mejor}}',
            objetivo: 'Capitalizar mejores pr√°cticas de {{segmento_mejor}} (score: {{score_mejor}})',
            tacticas: [
              'Documentar mejores pr√°cticas del segmento {{segmento_mejor}}',
              'Crear programa de cross-training entre segmentos',
              'Implementar herramientas exitosas en otros segmentos',
              'Reconocer y premiar al segmento l√≠der'
            ],
            meta_smart: 'Incrementar score promedio general en 5 pts en 90 d√≠as',
            metrica: 'Score promedio general, adopci√≥n de mejores pr√°cticas'
          }
        ]
      },
      priorizacion: {
        multiplicadores: { error_fatal: 10, error_critico: 5, gap_alto: 3, brecha_segmento: 2, oportunidad: 1 },
        umbralesPrioridad: { critica: 100, alta: 50, media: 20 }
      },
      calculoMetas: {
        reduccionEsperada: { critica: 0.5, alta: 0.3, media: 0.2 },
        plazos: { critica: '30 d√≠as', alta: '60 d√≠as', media: '90 d√≠as' }
      },
      palabrasClave: {
        Q20: ['tipificaci√≥n','tipifica','ortograf√≠a','gram√°tica','evidencia','nota','hermes','query'],
        Q17: ['hold','espera','l√≠nea','linea','minuto','retomar','retoma','60 segundos'],
        Q19: ['autogesti√≥n','autogestion','autonom√≠a'],
        Q11: ['soluci√≥n','solucion','resolver','problema','incidencia','escalamiento'],
        Q18: ['disculpas','corporativa','inconveniente'],
        Q21: ['transferencia','escalamiento','derivar','escalar'],
        Q4:  ['direcci√≥n','conversaci√≥n','control','llamada'],
        Q12: ['recontacto','vuelve a llamar','contacta nuevamente'],
        Q15: ['seguridad','pol√≠tica','identidad','autenticaci√≥n','validaci√≥n'],
        general_positivo: ['excelente','muy bien','felicidades','perfecto','cumple'],
        general_negativo: ['error','falla','no cumple','omite','incorrecto','errada']
      },
      formatoDocumento: { topHallazgos: 5 },
      coloresCuartiles: {
        Q1: { emoji: 'üü¢', label: 'Excelente', rango: '‚â•85' },
        Q2: { emoji: 'üü°', label: 'Aceptable', rango: '75-84' },
        Q3: { emoji: 'üü†', label: 'En riesgo', rango: '65-74' },
        Q4: { emoji: 'üî¥', label: 'Cr√≠tico', rango: '<65' }
      },
      roadmap: {
        mes1: {
          titulo: 'Intervenciones de Emergencia', periodo: 'D√≠as 1-30',
          acciones: [
            { semana: 'S1', accion: 'Identificar y sacar de operaci√≥n agentes score=0', responsable: 'Supervisores + RRHH', entregable: 'Lista de agentes, plan individual' },
            { semana: 'S1-S2', accion: 'Comunicar protocolo 3 strikes a toda la operaci√≥n', responsable: 'Gerencia de Calidad', entregable: 'Comunicado oficial' },
            { semana: 'S2-S3', accion: 'Lanzar certificaciones obligatorias para criterios cr√≠ticos', responsable: 'Training', entregable: 'M√≥dulos e-learning activos' },
            { semana: 'S3-S4', accion: 'Implementar coaching intensivo para agentes en riesgo', responsable: 'Supervisores', entregable: 'Planes de mejora firmados' }
          ]
        },
        mes2: {
          titulo: 'Mejora Estructural', periodo: 'D√≠as 31-60',
          acciones: [
            { semana: 'S5-S6', accion: 'Programa de mentor√≠a: top performers ‚Üí agentes con oportunidad', responsable: 'Quality + Training', entregable: 'Parejas asignadas, cronograma' },
            { semana: 'S5-S6', accion: 'Benchmark entre BPOs/segmentos', responsable: 'Quality', entregable: 'Documento de mejores pr√°cticas' },
            { semana: 'S7-S8', accion: 'Implementar validaciones autom√°ticas (tipificaci√≥n, etc.)', responsable: 'IT + Quality', entregable: 'Sistema en producci√≥n' },
            { semana: 'S7-S8', accion: 'Recalibraci√≥n de analistas de calidad', responsable: 'Quality', entregable: 'Calibraci√≥n completada' }
          ]
        },
        mes3: {
          titulo: 'Sostenibilidad', periodo: 'D√≠as 61-90',
          acciones: [
            { semana: 'S9-S10', accion: 'Evaluar progreso: comparar m√©tricas pre vs post', responsable: 'Quality', entregable: 'Reporte comparativo' },
            { semana: 'S9-S10', accion: 'Ajustar acciones seg√∫n resultados', responsable: 'Gerencia', entregable: 'Plan actualizado' },
            { semana: 'S11-S12', accion: 'Documentar mejores pr√°cticas y lecciones aprendidas', responsable: 'Quality', entregable: 'Knowledge base actualizado' },
            { semana: 'S11-S12', accion: 'Definir modelo de sostenibilidad', responsable: 'Gerencia', entregable: 'Modelo operativo aprobado' }
          ]
        }
      },
      governance: {
        reuniones: [
          { nombre: 'War Room Calidad', frecuencia: 'Semanal', participantes: 'Quality, Supervisores, Training', objetivo: 'Revisar m√©tricas, coaching cases' },
          { nombre: 'Steering Committee', frecuencia: 'Quincenal', participantes: 'Gerencia, Quality, RRHH', objetivo: 'Avance roadmap, decisiones' },
          { nombre: 'Review Ejecutivo', frecuencia: 'Mensual', participantes: 'Direcci√≥n, Gerencia', objetivo: 'Resultados, inversiones, ajustes' }
        ],
        duenos: [
          { hallazgo: 'Errores fatales', owner: 'Gerencia de Calidad', soporte: 'RRHH, Supervisores', escalamiento: 'Direcci√≥n' },
          { hallazgo: 'Gaps cr√≠ticos', owner: 'Training & Development', soporte: 'Quality, Supervisores', escalamiento: 'Gerencia' },
          { hallazgo: 'Brechas segmentos', owner: 'Gerencia de Operaciones', soporte: 'Quality, BPOs', escalamiento: 'Direcci√≥n' },
          { hallazgo: 'Agentes en riesgo', owner: 'Supervisores directos', soporte: 'Quality, RRHH', escalamiento: 'Gerencia' }
        ]
      }
    };


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ANALYSIS ENGINE (client-side port)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function _num(val) {
      if (val === null || val === undefined || val === '') return null;
      const n = Number(val);
      return isNaN(n) ? null : n;
    }
    function _round(val, dec = 2) {
      return Math.round(val * Math.pow(10, dec)) / Math.pow(10, dec);
    }
    function _safeDiv(a, b) { return b === 0 ? 0 : a / b; }

    // ‚îÄ‚îÄ Build column map from atributos_evaluacion ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildColMap(data) {
      const cols = data.atributos_evaluacion || data.columnas || [];
      const map = {};
      cols.forEach(c => { map[c.columna] = c; });
      return map;
    }

    // ‚îÄ‚îÄ 1. M√©tricas generales ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function calcularMetricasGenerales(records) {
      const scores = records.map(r => _num(r['QA SCORE'])).filter(v => v !== null);
      const agentes = new Set(records.map(r => r['ID AGENTE']).filter(Boolean));
      const supervisores = new Set(records.map(r => r['SUPERVISOR']).filter(Boolean));
      const analistas = new Set(records.map(r => r['ANALISTA']).filter(Boolean));

      const cuartiles = { Q1: 0, Q2: 0, Q3: 0, Q4: 0 };
      records.forEach(r => { const c = r['CUARTIL']; if (c && cuartiles.hasOwnProperty(c)) cuartiles[c]++; });

      const bpoMap = {};
      records.forEach(r => {
        const bpo = r['BPO'] || 'SIN_BPO';
        if (!bpoMap[bpo]) bpoMap[bpo] = { total: 0, scores: [] };
        bpoMap[bpo].total++;
        const s = _num(r['QA SCORE']);
        if (s !== null) bpoMap[bpo].scores.push(s);
      });
      const bpos = {};
      Object.entries(bpoMap).forEach(([k, v]) => {
        bpos[k] = { total: v.total, scorePromedio: v.scores.length > 0 ? _round(v.scores.reduce((a,b)=>a+b,0)/v.scores.length) : 0 };
      });

      const totalAuditorias = records.length;
      const cuartilesPct = {};
      Object.entries(cuartiles).forEach(([k, v]) => {
        cuartilesPct[k] = { cantidad: v, porcentaje: _round(_safeDiv(v * 100, totalAuditorias)) };
      });

      const sorted = [...scores].sort((a,b)=>a-b);
      const mediana = sorted.length > 0 ? (sorted.length%2===0 ? (sorted[sorted.length/2-1]+sorted[sorted.length/2])/2 : sorted[Math.floor(sorted.length/2)]) : 0;
      const mean = scores.length > 0 ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
      const variance = scores.length > 0 ? scores.reduce((s,v)=>s+Math.pow(v-mean,2),0)/scores.length : 0;

      return {
        totalAuditorias, scorePromedio: _round(mean), scoreMediana: _round(mediana),
        scoreDesviacion: _round(Math.sqrt(variance)), scoreMin: scores.length ? Math.min(...scores) : 0,
        scoreMax: scores.length ? Math.max(...scores) : 0, agentesUnicos: agentes.size,
        supervisoresUnicos: supervisores.size, analistasUnicos: analistas.size,
        cuartiles: cuartilesPct, bpos
      };
    }

    // ‚îÄ‚îÄ 2. Gaps por criterio ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function identificarGapsCriterios(records, colMap) {
      const resultados = [];
      CONFIG.criteriosConPuntaje.forEach(q => {
        const colInfo = colMap[q];
        if (!colInfo || !colInfo.puntaje) return;
        const puntajeMax = colInfo.puntaje;
        const valores = records.map(r => _num(r[q])).filter(v => v !== null);
        if (valores.length === 0) return;
        const promedio = valores.reduce((a,b)=>a+b,0)/valores.length;
        const conError = valores.filter(v => v < puntajeMax).length;
        const cumple = valores.filter(v => v >= puntajeMax).length;
        const gap = puntajeMax - promedio;
        const gapPonderado = _safeDiv(gap, puntajeMax) * 100;
        resultados.push({
          criterio: q, descripcion: colInfo.descripcion || q, puntajeMaximo: puntajeMax,
          promedioObtenido: _round(promedio), gap: _round(gap), gapPonderado: _round(gapPonderado),
          totalEvaluados: valores.length, conError, porcentajeError: _round(_safeDiv(conError*100, valores.length)),
          cumple, porcentajeCumple: _round(_safeDiv(cumple*100, valores.length)),
          indicadores: colInfo.indicadores || [], esCritico: CONFIG.criteriosCriticos.includes(q)
        });
      });
      resultados.sort((a,b)=>b.gapPonderado - a.gapPonderado);
      return resultados;
    }

    // ‚îÄ‚îÄ 3. Errores cr√≠ticos y fatales ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function detectarErroresCriticos(records, colMap) {
      const resultado = { criticos: [], fatales: [] };
      CONFIG.criteriosFatales.forEach(q => {
        const colInfo = colMap[q];
        const valores = records.map(r => _num(r[q])).filter(v => v !== null);
        const conError = valores.filter(v => v === 0).length;
        resultado.fatales.push({
          criterio: q, descripcion: colInfo ? colInfo.descripcion : q,
          totalEvaluados: valores.length, conError,
          porcentajeError: _round(_safeDiv(conError*100, valores.length))
        });
      });
      CONFIG.criteriosCriticos.forEach(q => {
        const colInfo = colMap[q];
        if (!colInfo || !colInfo.puntaje) return;
        const pMax = colInfo.puntaje;
        const valores = records.map(r => _num(r[q])).filter(v => v !== null);
        const conError = valores.filter(v => v < pMax).length;
        resultado.criticos.push({
          criterio: q, descripcion: colInfo.descripcion, puntajeMaximo: pMax,
          totalEvaluados: valores.length, conError,
          porcentajeError: _round(_safeDiv(conError*100, valores.length))
        });
      });
      return resultado;
    }

    // ‚îÄ‚îÄ 4. An√°lisis por segmento ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function analizarPorSegmento(records) {
      const dimensiones = ['BPO','DATA_CANAL','DATA_SKILL','DATA_SUB_SKILL'];
      const resultados = {};
      dimensiones.forEach(dim => {
        const mapa = {};
        records.forEach(r => {
          const val = r[dim] || 'SIN_DATO';
          if (!mapa[val]) mapa[val] = { scores: [], total: 0, cuartiles: {Q1:0,Q2:0,Q3:0,Q4:0} };
          mapa[val].total++;
          const s = _num(r['QA SCORE']);
          if (s !== null) mapa[val].scores.push(s);
          const c = r['CUARTIL'];
          if (c && mapa[val].cuartiles.hasOwnProperty(c)) mapa[val].cuartiles[c]++;
        });
        const segmentos = Object.entries(mapa).map(([nombre, info]) => ({
          nombre, total: info.total, cuartiles: info.cuartiles,
          scorePromedio: info.scores.length > 0 ? _round(info.scores.reduce((a,b)=>a+b,0)/info.scores.length) : 0
        })).sort((a,b)=>b.scorePromedio - a.scorePromedio);
        const sc = segmentos.map(s=>s.scorePromedio);
        const gap = sc.length >= 2 ? _round(Math.max(...sc)-Math.min(...sc)) : 0;
        resultados[dim] = { segmentos, mejor: segmentos[0]||null, peor: segmentos[segmentos.length-1]||null, gap };
      });
      return resultados;
    }

    // ‚îÄ‚îÄ 5. Text mining ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function analizarComentarios(records) {
      const palabrasClave = CONFIG.palabrasClave;
      const conteos = {};
      const comentariosTotal = records.filter(r => r['COMENTARIOS'] && r['COMENTARIOS'].trim().length > 0).length;
      Object.keys(palabrasClave).forEach(cat => {
        conteos[cat] = { total: 0, palabras: {} };
        palabrasClave[cat].forEach(p => { conteos[cat].palabras[p] = 0; });
      });
      records.forEach(r => {
        const com = (r['COMENTARIOS']||'').toLowerCase();
        if (!com) return;
        Object.entries(palabrasClave).forEach(([cat, palabras]) => {
          palabras.forEach(p => { if (com.includes(p.toLowerCase())) { conteos[cat].palabras[p]++; conteos[cat].total++; } });
        });
      });
      const todas = [];
      Object.entries(conteos).forEach(([cat, info]) => {
        Object.entries(info.palabras).forEach(([palabra, count]) => { if (count > 0) todas.push({ categoria: cat, palabra, count }); });
      });
      todas.sort((a,b)=>b.count - a.count);
      return { comentariosTotal, conteosPorCategoria: conteos, topPalabras: todas.slice(0,15) };
    }

    // ‚îÄ‚îÄ 6. Agentes en riesgo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function identificarAgentesRiesgo(records) {
      const agentesMap = {};
      records.forEach(r => {
        const id = r['ID AGENTE'];
        if (!id) return;
        if (!agentesMap[id]) agentesMap[id] = { id, nombre: r['AGENTE'], supervisor: r['SUPERVISOR'], bpo: r['BPO'], scores: [], erroresQ12: 0, erroresQ15: 0, auditorias: 0 };
        agentesMap[id].auditorias++;
        const s = _num(r['QA SCORE']);
        if (s !== null) agentesMap[id].scores.push(s);
        if (_num(r['Q12']) === 0) agentesMap[id].erroresQ12++;
        if (_num(r['Q15']) === 0) agentesMap[id].erroresQ15++;
      });
      const agentes = Object.values(agentesMap).map(a => {
        const avg = a.scores.length > 0 ? _round(a.scores.reduce((x,y)=>x+y,0)/a.scores.length) : 0;
        return { ...a, scorePromedio: avg, erroresFatales: a.erroresQ12+a.erroresQ15, tieneScoreCero: a.scores.some(s=>s===0) };
      });
      return {
        enRiesgo: agentes.filter(a=>a.scorePromedio < CONFIG.umbrales.scoreRiesgo).sort((a,b)=>a.scorePromedio-b.scorePromedio),
        conScoreCero: agentes.filter(a=>a.tieneScoreCero),
        topPerformers: agentes.filter(a=>a.scorePromedio >= CONFIG.umbrales.scoreExcelente && a.auditorias >= 2).sort((a,b)=>b.scorePromedio-a.scorePromedio),
        totalAgentes: agentes.length
      };
    }

    // ‚îÄ‚îÄ 7. Supervisores ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function analizarSupervisores(records) {
      const supMap = {};
      records.forEach(r => {
        const sup = r['SUPERVISOR'];
        if (!sup) return;
        if (!supMap[sup]) supMap[sup] = { nombre: sup, scores: [], agentes: new Set(), bpo: r['BPO'] };
        supMap[sup].agentes.add(r['ID AGENTE']);
        const s = _num(r['QA SCORE']);
        if (s !== null) supMap[sup].scores.push(s);
      });
      return Object.values(supMap).map(s => {
        const avg = s.scores.length > 0 ? _round(s.scores.reduce((a,b)=>a+b,0)/s.scores.length) : 0;
        const variance = s.scores.length > 1 ? s.scores.reduce((sum,v)=>sum+Math.pow(v-avg,2),0)/s.scores.length : 0;
        return { nombre: s.nombre, bpo: s.bpo, agentesUnicos: s.agentes.size, auditorias: s.scores.length, scorePromedio: avg, desviacion: _round(Math.sqrt(variance)) };
      }).sort((a,b)=>b.scorePromedio - a.scorePromedio);
    }

    // ‚îÄ‚îÄ 8. Detector de hallazgos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function detectarHallazgos(analisis) {
      const todos = [];

      // REGLA 4: Errores fatales
      analisis.errores.fatales.forEach(ef => {
        if (ef.porcentajeError > CONFIG.umbrales.errorFatal) {
          todos.push({
            id: `FATAL-${ef.criterio}`, tipo: 'error_fatal', subtipo: 'error_fatal',
            criterio: ef.criterio, criterioDesc: ef.descripcion, datos: ef,
            scorePriorizacion: _round(ef.porcentajeError * CONFIG.priorizacion.multiplicadores.error_fatal),
            regla: 'REGLA 4: Error fatal (>' + CONFIG.umbrales.errorFatal + '% auditor√≠as)'
          });
        }
      });

      // REGLA 1: Gaps cr√≠ticos
      const gapsAltos = analisis.gaps.filter(g => g.gapPonderado > CONFIG.umbrales.gapCritico).slice(0,5);
      gapsAltos.forEach((g, idx) => {
        const tipo = g.esCritico ? 'error_critico' : 'gap_alto';
        const mult = CONFIG.priorizacion.multiplicadores[tipo] || 3;
        todos.push({
          id: `GAP-${idx+1}`, tipo: 'gap_criterio', subtipo: tipo, criterio: g.criterio,
          criterioDesc: g.descripcion, datos: g, indicadores: g.indicadores,
          scorePriorizacion: _round(g.porcentajeError * g.puntajeMaximo * mult / 100),
          regla: 'REGLA 1: Gap cr√≠tico en criterio'
        });
      });

      // REGLA 2: Errores frecuentes
      analisis.gaps.filter(g => g.porcentajeError > CONFIG.umbrales.errorFrecuente).forEach((g, idx) => {
        todos.push({
          id: `ERR-${idx+1}`, tipo: 'error_frecuente', subtipo: 'error_frecuente', criterio: g.criterio,
          criterioDesc: g.descripcion, datos: g, indicadores: g.indicadores,
          scorePriorizacion: _round(g.porcentajeError * g.puntajeMaximo * CONFIG.priorizacion.multiplicadores.error_critico / 100),
          regla: 'REGLA 2: Error frecuente (>' + CONFIG.umbrales.errorFrecuente + '% auditor√≠as)'
        });
      });

      // REGLA 3: Brechas segmentos
      const dimLabels = { BPO:'BPO', DATA_CANAL:'Canal', DATA_SKILL:'Skill', DATA_SUB_SKILL:'Sub-Skill' };
      Object.entries(analisis.segmentos).forEach(([dim, info]) => {
        if (info.gap >= CONFIG.umbrales.gapSegmento && info.mejor && info.peor) {
          todos.push({
            id: `BRECHA-${dim}`, tipo: 'brecha_segmento', subtipo: `brecha_${dim.toLowerCase()}`,
            dimension: dim, dimensionLabel: dimLabels[dim]||dim,
            segmentoMejor: info.mejor.nombre, scoreMejor: info.mejor.scorePromedio,
            segmentoPeor: info.peor.nombre, scorePeor: info.peor.scorePromedio,
            gap: info.gap, segmentos: info.segmentos, datos: info,
            scorePriorizacion: _round(info.gap * CONFIG.priorizacion.multiplicadores.brecha_segmento),
            regla: 'REGLA 3: Brecha entre segmentos (>' + CONFIG.umbrales.gapSegmento + ' pts)'
          });
        }
      });

      // REGLA 5: Oportunidades
      const promGeneral = analisis.metricas.scorePromedio;
      Object.entries(analisis.segmentos).forEach(([dim, info]) => {
        info.segmentos.forEach(seg => {
          if (seg.scorePromedio > promGeneral + 15) {
            todos.push({
              id: `OPORT-${dim}-${seg.nombre}`, tipo: 'oportunidad', subtipo: 'oportunidad',
              dimension: dim, segmento: seg.nombre, scoreSegmento: seg.scorePromedio, scoreGeneral: promGeneral,
              diferencia: _round(seg.scorePromedio - promGeneral), datos: seg,
              scorePriorizacion: _round((seg.scorePromedio - promGeneral) * CONFIG.priorizacion.multiplicadores.oportunidad),
              regla: 'REGLA 5: Oportunidad (score > promedio + 15)'
            });
          }
        });
      });

      // Deduplicar
      const vistos = new Map();
      todos.forEach(h => {
        const key = h.criterio || h.id;
        if (!vistos.has(key) || vistos.get(key).scorePriorizacion < h.scorePriorizacion) vistos.set(key, h);
      });
      const deduplicados = Array.from(vistos.values()).sort((a,b)=>b.scorePriorizacion - a.scorePriorizacion);
      const top = deduplicados.slice(0, CONFIG.formatoDocumento.topHallazgos);
      const umbP = CONFIG.priorizacion.umbralesPrioridad;
      top.forEach((h,i) => {
        h.prioridadCalculada = h.scorePriorizacion >= umbP.critica ? 'CRITICA' : h.scorePriorizacion >= umbP.alta ? 'ALTA' : 'MEDIA';
        h.orden = i + 1;
      });
      return top;
    }

    // ‚îÄ‚îÄ 9. Generador de Insights ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function generarInsight(hallazgo, analisis) {
      const cr = CONFIG.causasRaiz;
      let causas;
      if (hallazgo.tipo === 'error_fatal') causas = cr[`error_fatal_${hallazgo.criterio}`] || cr.gap_criterio_generico;
      else if (hallazgo.tipo === 'gap_criterio' || hallazgo.tipo === 'error_frecuente') causas = cr[`gap_criterio_${hallazgo.criterio}`] || cr.gap_criterio_generico;
      else if (hallazgo.tipo === 'brecha_segmento') {
        const dim = (hallazgo.dimension||'').toLowerCase();
        causas = dim === 'bpo' ? cr.brecha_bpo : dim === 'data_canal' ? cr.brecha_canal : cr.brecha_skill;
      } else if (hallazgo.tipo === 'oportunidad') {
        causas = (hallazgo.dimension||'').toLowerCase() === 'data_canal' ? cr.oportunidad_canal : cr.oportunidad_segmento;
      } else causas = cr.gap_criterio_generico;

      // Impacto
      const indicadores = (hallazgo.indicadores || []).map(ind => ({ indicador: ind, descripcion: CONFIG.impactoPorIndicador[ind] || 'Impacto en operaci√≥n' }));
      let severidad = 'MEDIA';
      if (hallazgo.tipo === 'error_fatal') severidad = 'MUY ALTA';
      else if (hallazgo.scorePriorizacion >= CONFIG.priorizacion.umbralesPrioridad.critica) severidad = 'ALTA';
      else if (hallazgo.scorePriorizacion >= CONFIG.priorizacion.umbralesPrioridad.alta) severidad = 'MEDIA-ALTA';

      // Patrones
      const patrones = [];
      if (hallazgo.criterio && analisis.comentarios.conteosPorCategoria[hallazgo.criterio]) {
        const cat = analisis.comentarios.conteosPorCategoria[hallazgo.criterio];
        if (cat.total > 0) {
          const topP = Object.entries(cat.palabras).filter(([,c])=>c>0).sort((a,b)=>b[1]-a[1]).slice(0,5);
          patrones.push({ tipo: 'text_mining', descripcion: `${cat.total} menciones en comentarios`, detalle: topP.map(([p,c])=>`"${p}" (${c})`) });
        }
      }
      if (analisis.agentes.enRiesgo.length > 0) {
        patrones.push({ tipo: 'agentes', descripcion: `${analisis.agentes.enRiesgo.length} agentes con score <${CONFIG.umbrales.scoreRiesgo}` });
      }

      // Narrativa
      let narrativa = '';
      if (hallazgo.tipo === 'error_fatal') {
        narrativa = `El hallazgo de errores fatales en ${hallazgo.criterioDesc} representa un riesgo ${severidad.toLowerCase()} para la operaci√≥n, con ${hallazgo.datos.porcentajeError}% de incidencia.`;
      } else if (hallazgo.tipo === 'gap_criterio' || hallazgo.tipo === 'error_frecuente') {
        narrativa = `El criterio "${hallazgo.criterioDesc}" muestra un gap ponderado de ${hallazgo.datos.gapPonderado}%, con ${hallazgo.datos.porcentajeError}% de auditor√≠as con error.`;
      } else if (hallazgo.tipo === 'brecha_segmento') {
        narrativa = `Brecha de ${hallazgo.gap} puntos entre ${hallazgo.segmentoMejor} (${hallazgo.scoreMejor}) y ${hallazgo.segmentoPeor} (${hallazgo.scorePeor}).`;
      } else if (hallazgo.tipo === 'oportunidad') {
        narrativa = `${hallazgo.segmento} supera el promedio general en ${hallazgo.diferencia} puntos. Oportunidad de replicaci√≥n.`;
      }
      if (patrones.length > 0 && patrones[0].tipo === 'text_mining') narrativa += ` An√°lisis de comentarios: ${patrones[0].descripcion}.`;

      return { causasRaiz: causas, impactoNegocio: { indicadores, severidad }, patrones, narrativa };
    }

    // ‚îÄ‚îÄ 10. Generador de Acciones ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function generarAcciones(hallazgo) {
      const acc = CONFIG.accionesPorTipo;
      let templates;
      switch (hallazgo.tipo) {
        case 'error_fatal': templates = acc.error_fatal || []; break;
        case 'gap_criterio': templates = acc.gap_criterio || []; break;
        case 'error_frecuente': templates = acc.error_frecuente || []; break;
        case 'brecha_segmento': templates = acc.brecha_segmento || []; break;
        case 'oportunidad': templates = acc.oportunidad || []; break;
        default: templates = acc.gap_criterio || [];
      }
      const vars = {
        criterio: hallazgo.criterio || 'N/A', criterio_desc: hallazgo.criterioDesc || 'criterio no especificado',
        pct_error: hallazgo.datos?.porcentajeError || 0, gap: hallazgo.gap || hallazgo.datos?.gap || 0,
        meta_critica: _round((hallazgo.datos?.porcentajeError || 25) * 0.5),
        segmento_mejor: hallazgo.segmentoMejor || 'mejor segmento',
        segmento_peor: hallazgo.segmentoPeor || 'segmento con oportunidad',
        score_mejor: hallazgo.scoreMejor || 0, score_peor: hallazgo.scorePeor || 0,
        meta_gap: hallazgo.gap ? _round(hallazgo.gap / 2) : 7.5
      };
      const personalize = str => str ? str.replace(/\{\{(\w+)\}\}/g, (_, key) => vars[key] !== undefined ? vars[key] : `{{${key}}}`) : str;
      return templates.map(t => ({
        prioridad: t.prioridad, titulo: personalize(t.titulo), objetivo: personalize(t.objetivo),
        tacticas: t.tacticas.map(tc => personalize(tc)), meta_smart: personalize(t.meta_smart), metrica: personalize(t.metrica)
      }));
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MAIN ORCHESTRATOR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function ejecutarAnalisis(records, colMap) {
      const metricas = calcularMetricasGenerales(records);
      const gaps = identificarGapsCriterios(records, colMap);
      const errores = detectarErroresCriticos(records, colMap);
      const segmentos = analizarPorSegmento(records);
      const comentarios = analizarComentarios(records);
      const agentes = identificarAgentesRiesgo(records);
      const supervisores = analizarSupervisores(records);

      const analisis = { metricas, gaps, errores, segmentos, comentarios, agentes, supervisores };
      const hallazgos = detectarHallazgos(analisis);

      hallazgos.forEach(h => {
        h.insight = generarInsight(h, analisis);
        h.acciones = generarAcciones(h);
      });

      return { analisis, hallazgos };
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RENDERER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const chartsCreated = [];

    function scoreColor(s) { return s >= 85 ? 'var(--hia-green)' : s >= 75 ? 'var(--hia-yellow)' : s >= 65 ? 'var(--hia-orange)' : 'var(--hia-red)'; }
    function scoreBadge(s) { return s >= 85 ? 'q1' : s >= 75 ? 'q2' : s >= 65 ? 'q3' : 'q4'; }
    function prioColor(p) { return p === 'CRITICA' ? '#ef4444' : p === 'ALTA' ? '#f59e0b' : '#3b82f6'; }
    function prioBadge(p) { return p === 'CRITICA' ? 'critica' : p === 'ALTA' ? 'alta' : 'media'; }

    function renderPage(resultado) {
      const { analisis, hallazgos } = resultado;
      const m = analisis.metricas;

      const container = document.getElementById('contenidoPrincipal');
      container.innerHTML = '';

      // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
      const fecha = new Date();
      const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
      const fechaStr = `${fecha.getDate()} de ${meses[fecha.getMonth()]} de ${fecha.getFullYear()}`;

      container.innerHTML = `
        <div>
          <h2>üéØ Hallazgos ‚Üí Insights ‚Üí Acciones</h2>
          <p>Modelo anal√≠tico de 3 capas para transformar datos operativos en iniciativas accionables</p>
        </div>
        <BR><BR>

        <nav class="hia-nav" id="hiaNav">
          <button class="hia-nav-btn active" data-section="metodologia">üìê Metodolog√≠a</button>
          <button class="hia-nav-btn" data-section="contexto">üè¢ Contexto</button>
          <button class="hia-nav-btn" data-section="panoramica">üî≠ Vista Panor√°mica</button>
          <button class="hia-nav-btn" data-section="hallazgos">üìä Hallazgos (${hallazgos.length})</button>
          <button class="hia-nav-btn" data-section="resumen">üìã Resumen Ejecutivo</button>
          <button class="hia-nav-btn" data-section="roadmap">üóìÔ∏è Roadmap</button>
          <button class="hia-nav-btn" data-section="governance">üèõÔ∏è Governance</button>
        </nav>

        <div id="secMetodologia" class="hia-section active"></div>
        <div id="secContexto" class="hia-section"></div>
        <div id="secPanoramica" class="hia-section"></div>
        <div id="secHallazgos" class="hia-section"></div>
        <div id="secResumen" class="hia-section"></div>
        <div id="secRoadmap" class="hia-section"></div>
        <div id="secGovernance" class="hia-section"></div>
      `;

      // Nav logic
      document.querySelectorAll('.hia-nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.hia-nav-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.hia-section').forEach(s => s.classList.remove('active'));
          btn.classList.add('active');
          const sec = btn.dataset.section;
          const secMap = { metodologia:'secMetodologia', contexto:'secContexto', panoramica:'secPanoramica', hallazgos:'secHallazgos', resumen:'secResumen', roadmap:'secRoadmap', governance:'secGovernance' };
          document.getElementById(secMap[sec]).classList.add('active');
          setTimeout(notifyHeight, 100);
        });
      });

      renderMetodologia();
      renderContexto(analisis);
      renderPanoramica(analisis);
      renderHallazgos(hallazgos, analisis);
      renderResumen(hallazgos, analisis);
      renderRoadmap();
      renderGovernance();
    }

    // ‚îÄ‚îÄ SECTION 1: Metodolog√≠a ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderMetodologia() {
      document.getElementById('secMetodologia').innerHTML = `
        <div class="hia-section-title"><span class="icon" style="background:var(--hia-blue-light);color:var(--hia-blue);">üìê</span> Metodolog√≠a</div>
        <div class="hia-card">
          <div class="hia-card-title">Modelo Hallazgos ‚Üí Insights ‚Üí Acciones (H‚ÜíI‚ÜíA)</div>
          <p style="font-size:14px;color:var(--hia-text-sec);margin-bottom:20px;">Este an√°lisis aplica un modelo de 3 capas para transformar datos operativos en iniciativas accionables.</p>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:24px;">
            <div style="padding:20px;background:var(--hia-blue-light);border-radius:10px;border-left:4px solid var(--hia-blue);">
              <div style="font-weight:800;font-size:15px;margin-bottom:6px;">üìä HALLAZGOS</div>
              <div style="font-size:13px;color:var(--hia-text-sec);">Datos objetivos del an√°lisis cuantitativo</div>
              <div style="font-size:12px;margin-top:8px;color:var(--hia-blue);font-weight:600;">¬øQu√© dicen los datos?</div>
            </div>
            <div style="padding:20px;background:var(--hia-yellow-light);border-radius:10px;border-left:4px solid var(--hia-yellow);">
              <div style="font-weight:800;font-size:15px;margin-bottom:6px;">üí° INSIGHTS</div>
              <div style="font-size:13px;color:var(--hia-text-sec);">Interpretaci√≥n, causas ra√≠z e impacto</div>
              <div style="font-size:12px;margin-top:8px;color:#b45309;font-weight:600;">¬øPor qu√© est√° pasando?</div>
            </div>
            <div style="padding:20px;background:var(--hia-green-light);border-radius:10px;border-left:4px solid var(--hia-green);">
              <div style="font-weight:800;font-size:15px;margin-bottom:6px;">üé¨ ACCIONES</div>
              <div style="font-size:13px;color:var(--hia-text-sec);">Iniciativas priorizadas con metas SMART</div>
              <div style="font-size:12px;margin-top:8px;color:#047857;font-weight:600;">¬øQu√© hacemos al respecto?</div>
            </div>
          </div>
        </div>
        <div class="hia-card">
          <div class="hia-card-title">Reglas de Detecci√≥n Autom√°tica</div>
          <div class="hia-table-wrap"><table class="hia-table">
            <thead><tr><th>#</th><th>Regla</th><th>Umbral</th></tr></thead>
            <tbody>
              <tr><td>1</td><td>Gaps cr√≠ticos en criterios</td><td>Gap ponderado > ${CONFIG.umbrales.gapCritico}%</td></tr>
              <tr><td>2</td><td>Errores frecuentes</td><td>> ${CONFIG.umbrales.errorFrecuente}% de auditor√≠as con error</td></tr>
              <tr><td>3</td><td>Brechas entre segmentos</td><td>Gap > ${CONFIG.umbrales.gapSegmento} puntos</td></tr>
              <tr><td>4</td><td>Errores fatales (Q12/Q15)</td><td>> ${CONFIG.umbrales.errorFatal}% de incidencia</td></tr>
              <tr><td>5</td><td>Oportunidades de replicaci√≥n</td><td>Score > promedio + 15 pts</td></tr>
            </tbody>
          </table></div>
          <div style="margin-top:16px;padding:12px 16px;background:#f8fafc;border-radius:8px;font-size:13px;">
            <strong>F√≥rmula de Priorizaci√≥n:</strong> <code style="background:#e2e8f0;padding:2px 8px;border-radius:4px;">Score = frecuencia √ó impacto √ó multiplicador_tipo</code>
          </div>
        </div>`;
    }

    // ‚îÄ‚îÄ SECTION 2: Contexto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderContexto(analisis) {
      const m = analisis.metricas;
      let html = `<div class="hia-section-title"><span class="icon" style="background:var(--hia-purple-light);color:var(--hia-purple);">üè¢</span> Contexto General de la Operaci√≥n</div>`;

      // KPIs
      html += `<div class="hia-kpi-grid">
        <div class="hia-kpi"><div class="label">Total Auditor√≠as</div><div class="value">${m.totalAuditorias.toLocaleString()}</div></div>
        <div class="hia-kpi green"><div class="label">Score Promedio</div><div class="value" style="color:${scoreColor(m.scorePromedio)}">${m.scorePromedio}</div><div class="sub">Mediana: ${m.scoreMediana}</div></div>
        <div class="hia-kpi purple"><div class="label">Agentes Evaluados</div><div class="value">${m.agentesUnicos}</div><div class="sub">${m.supervisoresUnicos} supervisores</div></div>
        <div class="hia-kpi"><div class="label">Desviaci√≥n Est√°ndar</div><div class="value">${m.scoreDesviacion}</div><div class="sub">Min: ${m.scoreMin} | Max: ${m.scoreMax}</div></div>
      </div>`;

      // BPO + Cuartiles grid
      html += `<div class="hia-grid-2">
        <div class="hia-card"><div class="hia-card-title">Distribuci√≥n por BPO</div>`;
      Object.entries(m.bpos).forEach(([bpo, info]) => {
        html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid #f1f5f9;">
          <div><span style="font-weight:700;">${bpo}</span><span style="font-size:12px;color:var(--hia-text-sec);margin-left:8px;">${info.total} aud.</span></div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div class="hia-bar-bg" style="width:120px;"><div class="hia-bar-fill" style="width:${info.scorePromedio}%;background:${scoreColor(info.scorePromedio)};"></div></div>
            <span style="font-weight:700;color:${scoreColor(info.scorePromedio)};min-width:40px;text-align:right;">${info.scorePromedio}</span>
          </div>
        </div>`;
      });
      html += `</div>`;

      html += `<div class="hia-card"><div class="hia-card-title">Distribuci√≥n por Cuartil</div>`;
      const cConfig = CONFIG.coloresCuartiles;
      ['Q1','Q2','Q3','Q4'].forEach(c => {
        const info = m.cuartiles[c] || { cantidad:0, porcentaje:0 };
        const cc = cConfig[c];
        html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f1f5f9;">
          <div><span style="font-weight:700;">${cc.emoji} ${c}</span><span style="font-size:12px;color:var(--hia-text-sec);margin-left:6px;">${cc.rango}</span></div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div class="hia-bar-bg" style="width:100px;"><div class="hia-bar-fill" style="width:${info.porcentaje}%;background:${scoreColor(c==='Q1'?90:c==='Q2'?80:c==='Q3'?70:50)};"></div></div>
            <span style="font-size:13px;font-weight:600;min-width:75px;text-align:right;">${info.cantidad} (${info.porcentaje}%)</span>
          </div>
        </div>`;
      });
      html += `</div></div>`;

      // Chart: Cuartiles
      html += `<div class="hia-chart-grid">
        <div class="hia-chart-card"><div class="chart-title">Distribuci√≥n de Cuartiles</div><canvas id="chartCuartiles"></canvas></div>
        <div class="hia-chart-card"><div class="chart-title">Score por BPO</div><canvas id="chartBPO"></canvas></div>
      </div>`;

      document.getElementById('secContexto').innerHTML = html;

      // Render charts
      setTimeout(() => {
        const ctx1 = document.getElementById('chartCuartiles');
        if (ctx1) {
          chartsCreated.push(new Chart(ctx1, {
            type: 'doughnut',
            data: {
              labels: ['Q1 (‚â•85)', 'Q2 (75-84)', 'Q3 (65-74)', 'Q4 (<65)'],
              datasets: [{ data: [m.cuartiles.Q1?.cantidad||0, m.cuartiles.Q2?.cantidad||0, m.cuartiles.Q3?.cantidad||0, m.cuartiles.Q4?.cantidad||0],
                backgroundColor: ['#10b981','#f59e0b','#f97316','#ef4444'], borderWidth: 0 }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { font: { size: 12 } } } } }
          }));
        }
        const ctx2 = document.getElementById('chartBPO');
        if (ctx2) {
          const bpoNames = Object.keys(m.bpos);
          chartsCreated.push(new Chart(ctx2, {
            type: 'bar',
            data: {
              labels: bpoNames,
              datasets: [{ label: 'Score Promedio', data: bpoNames.map(b=>m.bpos[b].scorePromedio),
                backgroundColor: bpoNames.map(b=>scoreColor(m.bpos[b].scorePromedio)+'33'),
                borderColor: bpoNames.map(b=>scoreColor(m.bpos[b].scorePromedio)),
                borderWidth: 2, borderRadius: 8 }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
          }));
        }
      }, 50);
    }

    // ‚îÄ‚îÄ SECTION 3: Vista Panor√°mica ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderPanoramica(analisis) {
      let html = `<div class="hia-section-title"><span class="icon" style="background:#fef3c7;color:#b45309;">üî≠</span> Vista Panor√°mica</div>`;

      // Top gaps table
      html += `<div class="hia-card"><div class="hia-card-title">Top 10 Criterios con Mayor Gap Ponderado</div>
        <div class="hia-table-wrap"><table class="hia-table"><thead><tr><th>#</th><th>Criterio</th><th>Descripci√≥n</th><th class="num">M√°x</th><th class="num">Prom</th><th class="num">Gap%</th><th class="num">% Error</th></tr></thead><tbody>`;
      analisis.gaps.slice(0,10).forEach((g,i) => {
        html += `<tr><td>${i+1}</td><td><strong>${g.criterio}</strong></td><td>${g.descripcion}</td><td class="num">${g.puntajeMaximo}</td><td class="num">${g.promedioObtenido}</td><td class="num">${g.gapPonderado}%</td><td class="num"><span class="hia-badge ${g.porcentajeError>30?'critica':g.porcentajeError>15?'alta':'media'}">${g.porcentajeError}%</span></td></tr>`;
      });
      html += `</tbody></table></div></div>`;

      // Chart: Gaps
      html += `<div class="hia-chart-grid">
        <div class="hia-chart-card"><div class="chart-title">Gap Ponderado por Criterio (Top 10)</div><canvas id="chartGaps"></canvas></div>
        <div class="hia-chart-card"><div class="chart-title">Errores Fatales y Cr√≠ticos</div><canvas id="chartErrores"></canvas></div>
      </div>`;

      // Errores fatales table
      html += `<div class="hia-grid-2">
        <div class="hia-card"><div class="hia-card-title">‚ö†Ô∏è Errores Fatales</div>
          <div class="hia-table-wrap"><table class="hia-table"><thead><tr><th>Criterio</th><th>Descripci√≥n</th><th class="num">Errores</th><th class="num">%</th><th>Nivel</th></tr></thead><tbody>`;
      analisis.errores.fatales.forEach(e => {
        const nivel = e.porcentajeError > 10 ? '<span class="hia-badge critica">CR√çTICO</span>' : e.porcentajeError > 5 ? '<span class="hia-badge alta">ALTO</span>' : '<span class="hia-badge media">OK</span>';
        html += `<tr><td><strong>${e.criterio}</strong></td><td>${e.descripcion}</td><td class="num">${e.conError}/${e.totalEvaluados}</td><td class="num">${e.porcentajeError}%</td><td>${nivel}</td></tr>`;
      });
      html += `</tbody></table></div></div>`;

      // Errores cr√≠ticos
      html += `<div class="hia-card"><div class="hia-card-title">üî¥ Errores Cr√≠ticos (Q4, Q11, Q20)</div>
          <div class="hia-table-wrap"><table class="hia-table"><thead><tr><th>Criterio</th><th>Descripci√≥n</th><th class="num">Errores</th><th class="num">%</th></tr></thead><tbody>`;
      analisis.errores.criticos.forEach(e => {
        html += `<tr><td><strong>${e.criterio}</strong></td><td>${e.descripcion}</td><td class="num">${e.conError}/${e.totalEvaluados}</td><td class="num"><span class="hia-badge ${e.porcentajeError>25?'critica':'alta'}">${e.porcentajeError}%</span></td></tr>`;
      });
      html += `</tbody></table></div></div></div>`;

      // Brechas por segmento
      html += `<div class="hia-card"><div class="hia-card-title">üìä Brechas por Segmento</div>`;
      const dimLabels = { BPO:'BPO', DATA_CANAL:'Canal', DATA_SKILL:'Skill', DATA_SUB_SKILL:'Sub-Skill' };
      Object.entries(analisis.segmentos).forEach(([dim, info]) => {
        html += `<div style="margin-bottom:20px;"><div style="font-weight:700;font-size:14px;margin-bottom:10px;">${dimLabels[dim]||dim} ${info.gap >= CONFIG.umbrales.gapSegmento ? '<span class="hia-badge critica">Gap: '+info.gap+' pts</span>' : info.gap > 0 ? '<span class="hia-badge media">Gap: '+info.gap+' pts</span>' : ''}</div>`;
        info.segmentos.forEach(s => {
          html += `<div style="display:flex;align-items:center;gap:12px;padding:8px 0;">
            <span style="min-width:90px;font-weight:600;font-size:13px;">${s.nombre}</span>
            <div class="hia-bar-bg" style="flex:1;height:20px;border-radius:6px;">
              <div class="hia-bar-fill" style="width:${s.scorePromedio}%;background:${scoreColor(s.scorePromedio)};border-radius:6px;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;">
                <span style="color:white;font-size:11px;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,0.2);">${s.scorePromedio}</span>
              </div>
            </div>
            <span style="font-size:12px;color:var(--hia-text-sec);min-width:55px;">${s.total} aud.</span>
          </div>`;
        });
        html += `</div>`;
      });
      html += `</div>`;

      // Text mining
      html += `<div class="hia-card"><div class="hia-card-title">üîç Text Mining de Comentarios (${analisis.comentarios.comentariosTotal} analizados)</div>
        <div class="hia-table-wrap"><table class="hia-table"><thead><tr><th>#</th><th>Palabra Clave</th><th>Categor√≠a</th><th class="num">Menciones</th></tr></thead><tbody>`;
      analisis.comentarios.topPalabras.slice(0,10).forEach((p,i) => {
        html += `<tr><td>${i+1}</td><td>"${p.palabra}"</td><td><span class="hia-badge media">${p.categoria}</span></td><td class="num">${p.count}</td></tr>`;
      });
      html += `</tbody></table></div></div>`;

      // Agentes resumen
      html += `<div class="hia-kpi-grid" style="margin-top:20px;">
        <div class="hia-kpi"><div class="label">Total Agentes</div><div class="value">${analisis.agentes.totalAgentes}</div></div>
        <div class="hia-kpi red"><div class="label">Agentes en Riesgo</div><div class="value" style="color:var(--hia-red);">${analisis.agentes.enRiesgo.length}</div><div class="sub">Score &lt;${CONFIG.umbrales.scoreRiesgo}</div></div>
        <div class="hia-kpi red"><div class="label">Agentes Score=0</div><div class="value" style="color:var(--hia-red);">${analisis.agentes.conScoreCero.length}</div></div>
        <div class="hia-kpi green"><div class="label">Top Performers</div><div class="value" style="color:var(--hia-green);">${analisis.agentes.topPerformers.length}</div><div class="sub">Score ‚â•${CONFIG.umbrales.scoreExcelente}</div></div>
      </div>`;

      document.getElementById('secPanoramica').innerHTML = html;

      // Render charts
      setTimeout(() => {
        const ctxG = document.getElementById('chartGaps');
        if (ctxG) {
          const topGaps = analisis.gaps.slice(0,10);
          chartsCreated.push(new Chart(ctxG, {
            type: 'bar',
            data: {
              labels: topGaps.map(g=>g.criterio),
              datasets: [{ label: 'Gap Ponderado %', data: topGaps.map(g=>g.gapPonderado),
                backgroundColor: topGaps.map(g=>g.gapPonderado>30?'rgba(239,68,68,0.2)':g.gapPonderado>15?'rgba(245,158,11,0.2)':'rgba(59,130,246,0.2)'),
                borderColor: topGaps.map(g=>g.gapPonderado>30?'#ef4444':g.gapPonderado>15?'#f59e0b':'#3b82f6'),
                borderWidth: 2, borderRadius: 6 }]
            },
            options: { indexAxis: 'y', responsive: true, scales: { x: { beginAtZero: true } }, plugins: { legend: { display: false } } }
          }));
        }
        const ctxE = document.getElementById('chartErrores');
        if (ctxE) {
          const allErr = [...analisis.errores.fatales.map(e=>({...e, tipo:'Fatal'})), ...analisis.errores.criticos.map(e=>({...e, tipo:'Cr√≠tico'}))];
          chartsCreated.push(new Chart(ctxE, {
            type: 'bar',
            data: {
              labels: allErr.map(e=>e.criterio),
              datasets: [{ label: '% Error', data: allErr.map(e=>e.porcentajeError),
                backgroundColor: allErr.map(e=>e.tipo==='Fatal'?'rgba(239,68,68,0.3)':'rgba(245,158,11,0.3)'),
                borderColor: allErr.map(e=>e.tipo==='Fatal'?'#ef4444':'#f59e0b'),
                borderWidth: 2, borderRadius: 6 }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
          }));
        }
      }, 50);
    }

    // ‚îÄ‚îÄ SECTION 4: Hallazgos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderHallazgos(hallazgos, analisis) {
      let html = `<div class="hia-section-title"><span class="icon" style="background:var(--hia-red-light);color:var(--hia-red);">üìä</span> Hallazgos, Insights y Acciones</div>`;
      html += `<div class="hia-pill-row">`;
      const prioCounts = { CRITICA:0, ALTA:0, MEDIA:0 };
      hallazgos.forEach(h => prioCounts[h.prioridadCalculada]++);
      html += `<span class="hia-badge critica">üî¥ ${prioCounts.CRITICA} Cr√≠ticas</span>`;
      html += `<span class="hia-badge alta">üü° ${prioCounts.ALTA} Altas</span>`;
      html += `<span class="hia-badge media">üîµ ${prioCounts.MEDIA} Medias</span>`;
      html += `</div>`;

      hallazgos.forEach(h => {
        const hId = `hallazgo-${h.orden}`;
        const tipoLabel = h.tipo === 'error_fatal' ? 'Error Fatal' : h.tipo === 'gap_criterio' ? 'Gap Criterio' : h.tipo === 'error_frecuente' ? 'Error Frecuente' : h.tipo === 'brecha_segmento' ? 'Brecha Segmento' : 'Oportunidad';
        const title = h.criterioDesc || (h.dimensionLabel ? `Brecha ${h.dimensionLabel}: ${h.segmentoMejor} vs ${h.segmentoPeor}` : h.segmento || h.id);

        html += `<div class="hia-hallazgo" id="${hId}">
          <div class="hia-hallazgo-header" onclick="toggleHallazgo('${hId}')">
            <div class="hia-hallazgo-num" style="background:${prioColor(h.prioridadCalculada)}">${h.orden}</div>
            <div class="hia-hallazgo-info">
              <div class="hia-hallazgo-title">${title}</div>
              <div class="hia-hallazgo-meta">
                <span class="hia-badge ${prioBadge(h.prioridadCalculada)}">${h.prioridadCalculada}</span>
                <span>${tipoLabel}</span>
                <span>Score: ${h.scorePriorizacion}</span>
                <span>${h.regla}</span>
              </div>
            </div>
            <div class="hia-hallazgo-arrow">‚ñº</div>
          </div>
          <div class="hia-hallazgo-body">
            <div class="hia-layers">
              <button class="hia-layer-btn active-hallazgo" onclick="switchLayer('${hId}','hallazgo')">üìä Hallazgos</button>
              <button class="hia-layer-btn" onclick="switchLayer('${hId}','insight')">üí° Insights</button>
              <button class="hia-layer-btn" onclick="switchLayer('${hId}','accion')">üé¨ Acciones</button>
            </div>
            <div class="hia-layer-content active" id="${hId}-hallazgo">${renderHallazgoData(h)}</div>
            <div class="hia-layer-content" id="${hId}-insight">${renderInsightData(h)}</div>
            <div class="hia-layer-content" id="${hId}-accion">${renderAccionData(h)}</div>
          </div>
        </div>`;
      });

      document.getElementById('secHallazgos').innerHTML = html;
    }

    function renderHallazgoData(h) {
      if (h.tipo === 'brecha_segmento') {
        let html = `<div class="hia-table-wrap"><table class="hia-table"><thead><tr><th>M√©trica</th><th>Valor</th></tr></thead><tbody>
          <tr><td>Dimensi√≥n</td><td>${h.dimensionLabel}</td></tr>
          <tr><td>Segmento mejor</td><td><strong>${h.segmentoMejor}</strong> (${h.scoreMejor})</td></tr>
          <tr><td>Segmento peor</td><td><strong>${h.segmentoPeor}</strong> (${h.scorePeor})</td></tr>
          <tr><td>Gap</td><td><span style="color:var(--hia-red);font-weight:700;">${h.gap} pts</span></td></tr>
        </tbody></table></div>`;
        return html;
      }
      if (h.tipo === 'oportunidad') {
        return `<div class="hia-table-wrap"><table class="hia-table"><thead><tr><th>M√©trica</th><th>Valor</th></tr></thead><tbody>
          <tr><td>Segmento</td><td><strong>${h.segmento}</strong></td></tr>
          <tr><td>Score segmento</td><td>${h.scoreSegmento}</td></tr>
          <tr><td>Score general</td><td>${h.scoreGeneral}</td></tr>
          <tr><td>Diferencia</td><td><span style="color:var(--hia-green);font-weight:700;">+${h.diferencia} pts</span></td></tr>
        </tbody></table></div>`;
      }
      const d = h.datos;
      let rows = '';
      if (d.puntajeMaximo !== undefined) rows += `<tr><td>Puntaje m√°ximo</td><td>${d.puntajeMaximo}</td></tr>`;
      if (d.promedioObtenido !== undefined) rows += `<tr><td>Promedio obtenido</td><td>${d.promedioObtenido}</td></tr>`;
      if (d.gap !== undefined) rows += `<tr><td>Gap absoluto</td><td>${d.gap} pts</td></tr>`;
      if (d.gapPonderado !== undefined) rows += `<tr><td>Gap ponderado</td><td><strong>${d.gapPonderado}%</strong></td></tr>`;
      if (d.conError !== undefined) rows += `<tr><td>Auditor√≠as con error</td><td>${d.conError} de ${d.totalEvaluados} (<strong>${d.porcentajeError}%</strong>)</td></tr>`;
      if (d.porcentajeCumple !== undefined) rows += `<tr><td>% Cumplimiento</td><td>${d.porcentajeCumple}%</td></tr>`;
      if (h.indicadores && h.indicadores.length) rows += `<tr><td>Indicadores afectados</td><td>${h.indicadores.join(', ')}</td></tr>`;
      return `<div class="hia-table-wrap"><table class="hia-table"><thead><tr><th>M√©trica</th><th>Valor</th></tr></thead><tbody>${rows}</tbody></table></div>`;
    }

    function renderInsightData(h) {
      if (!h.insight) return '<p style="color:var(--hia-text-sec);font-size:13px;">No hay insights disponibles.</p>';
      const ins = h.insight;
      let html = `<div class="hia-narrative">${ins.narrativa}</div>`;
      html += `<div style="font-weight:700;font-size:14px;margin-bottom:10px;">Causas ra√≠z probables:</div><ul class="hia-causes">`;
      ins.causasRaiz.forEach(c => { html += `<li>${c}</li>`; });
      html += `</ul>`;
      if (ins.impactoNegocio.indicadores.length > 0) {
        html += `<div style="margin-top:16px;padding:14px;background:#f8fafc;border-radius:8px;">
          <div style="font-weight:700;font-size:13px;margin-bottom:8px;">Impacto en negocio (Severidad: ${ins.impactoNegocio.severidad})</div>`;
        ins.impactoNegocio.indicadores.forEach(i => {
          html += `<div style="font-size:13px;padding:4px 0;"><strong>${i.indicador}:</strong> ${i.descripcion}</div>`;
        });
        html += `</div>`;
      }
      if (ins.patrones.length > 0) {
        html += `<div style="margin-top:14px;font-weight:700;font-size:13px;margin-bottom:8px;">Patrones detectados:</div>`;
        ins.patrones.forEach(p => {
          html += `<div style="font-size:13px;padding:4px 0;">‚Ä¢ ${p.descripcion}${p.detalle ? ': ' + p.detalle.join(', ') : ''}</div>`;
        });
      }
      return html;
    }

    function renderAccionData(h) {
      if (!h.acciones || h.acciones.length === 0) return '<p style="color:var(--hia-text-sec);font-size:13px;">No hay acciones sugeridas.</p>';
      let html = '';
      h.acciones.forEach((acc, i) => {
        const prioEmoji = acc.prioridad === 'CRITICA' ? 'üî¥' : acc.prioridad === 'ALTA' ? 'üü°' : 'üü¢';
        html += `<div class="hia-action" style="border-left:4px solid ${prioColor(acc.prioridad)};">
          <div class="hia-action-header">
            <span class="hia-badge ${prioBadge(acc.prioridad)}">${prioEmoji} ${acc.prioridad}</span>
            <span class="hia-action-title">${acc.titulo}</span>
          </div>
          <div class="hia-action-obj"><strong>Objetivo:</strong> ${acc.objetivo}</div>
          <div class="hia-tactics">`;
        acc.tacticas.forEach(t => { html += `<div class="hia-tactic">${t}</div>`; });
        html += `</div>
          <div class="hia-smart">
            <div><strong>üéØ Meta SMART:</strong> ${acc.meta_smart}</div>
            <div style="margin-top:4px;"><strong>üìè M√©trica:</strong> ${acc.metrica}</div>
          </div>
        </div>`;
      });
      return html;
    }

    // ‚îÄ‚îÄ SECTION 5: Resumen Ejecutivo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderResumen(hallazgos, analisis) {
      const m = analisis.metricas;
      const prioCounts = { CRITICA:0, ALTA:0, MEDIA:0 };
      let totalAcciones = 0;
      hallazgos.forEach(h => { prioCounts[h.prioridadCalculada]++; totalAcciones += (h.acciones||[]).length; });
      const metaScore = _round(m.scorePromedio * 1.1);

      let html = `<div class="hia-section-title"><span class="icon" style="background:var(--hia-green-light);color:var(--hia-green);">üìã</span> Resumen Ejecutivo y Metas a 90 D√≠as</div>`;

      html += `<div class="hia-kpi-grid">
        <div class="hia-kpi"><div class="label">Hallazgos Detectados</div><div class="value">${hallazgos.length}</div></div>
        <div class="hia-kpi red"><div class="label">Prioridad Cr√≠tica</div><div class="value" style="color:var(--hia-red);">${prioCounts.CRITICA}</div></div>
        <div class="hia-kpi yellow"><div class="label">Prioridad Alta</div><div class="value" style="color:var(--hia-yellow);">${prioCounts.ALTA}</div></div>
        <div class="hia-kpi green"><div class="label">Total Acciones</div><div class="value" style="color:var(--hia-green);">${totalAcciones}</div></div>
      </div>`;

      // Metas a 90 d√≠as
      html += `<div class="hia-card"><div class="hia-card-title">üéØ Metas a 90 D√≠as</div>
        <div class="hia-table-wrap"><table class="hia-table"><thead><tr><th>Meta</th><th class="num">Baseline</th><th class="num">Objetivo</th><th>Plazo</th></tr></thead><tbody>
          <tr><td>Score promedio</td><td class="num">${m.scorePromedio}</td><td class="num" style="color:var(--hia-green);font-weight:700;">‚â•${metaScore}</td><td>90 d√≠as</td></tr>
          <tr><td>Cuartil Q4 (cr√≠tico)</td><td class="num">${m.cuartiles.Q4?.porcentaje||0}%</td><td class="num" style="color:var(--hia-green);font-weight:700;">&lt;${_round((m.cuartiles.Q4?.porcentaje||0)*0.5)}%</td><td>90 d√≠as</td></tr>
          <tr><td>Cuartil Q1 (excelente)</td><td class="num">${m.cuartiles.Q1?.porcentaje||0}%</td><td class="num" style="color:var(--hia-green);font-weight:700;">‚â•${_round((m.cuartiles.Q1?.porcentaje||0)*1.3)}%</td><td>90 d√≠as</td></tr>
          <tr><td>Agentes en riesgo</td><td class="num">${analisis.agentes.enRiesgo.length}</td><td class="num" style="color:var(--hia-green);font-weight:700;">&lt;${Math.ceil(analisis.agentes.enRiesgo.length*0.3)}</td><td>60 d√≠as</td></tr>
          <tr><td>Agentes score=0</td><td class="num">${analisis.agentes.conScoreCero.length}</td><td class="num" style="color:var(--hia-green);font-weight:700;">0</td><td>14 d√≠as</td></tr>
        </tbody></table></div></div>`;

      // ROI
      html += `<div class="hia-card"><div class="hia-card-title">üí∞ Estimaci√≥n de ROI</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;">
          <div style="padding:16px;background:var(--hia-blue-light);border-radius:10px;">
            <div style="font-weight:700;font-size:13px;margin-bottom:4px;">Inversi√≥n estimada</div>
            <div style="font-size:12px;color:var(--hia-text-sec);">Horas de coaching, training y desarrollo de herramientas</div>
          </div>
          <div style="padding:16px;background:var(--hia-green-light);border-radius:10px;">
            <div style="font-weight:700;font-size:13px;margin-bottom:4px;">Ahorro errores fatales</div>
            <div style="font-size:12px;color:var(--hia-text-sec);">Menor rotaci√≥n, menos escalamientos, mejor NPS</div>
          </div>
          <div style="padding:16px;background:var(--hia-yellow-light);border-radius:10px;">
            <div style="font-weight:700;font-size:13px;margin-bottom:4px;">Beneficio por score</div>
            <div style="font-size:12px;color:var(--hia-text-sec);">Cada punto de mejora reduce recontactos ~2-3%</div>
          </div>
          <div style="padding:16px;background:var(--hia-purple-light);border-radius:10px;">
            <div style="font-weight:700;font-size:13px;margin-bottom:4px;">ROI estimado</div>
            <div style="font-size:12px;color:var(--hia-text-sec);">3-5x en 6 meses por mejora en FCR y reducci√≥n de costos</div>
          </div>
        </div></div>`;

      document.getElementById('secResumen').innerHTML = html;
    }

    // ‚îÄ‚îÄ SECTION 6: Roadmap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderRoadmap() {
      const rm = CONFIG.roadmap;
      let html = `<div class="hia-section-title"><span class="icon" style="background:#fef3c7;color:#b45309;">üóìÔ∏è</span> Roadmap de Implementaci√≥n</div>`;

      html += `<div class="hia-timeline">`;
      const mesConfig = [
        { key:'mes1', cls:'mes1', icon:'üî¥' },
        { key:'mes2', cls:'mes2', icon:'üü°' },
        { key:'mes3', cls:'mes3', icon:'üü¢' }
      ];
      mesConfig.forEach(mc => {
        const mes = rm[mc.key];
        html += `<div class="hia-timeline-col ${mc.cls}">
          <div class="hia-timeline-title">${mc.icon} ${mes.titulo}</div>
          <div class="hia-timeline-period">${mes.periodo}</div>`;
        mes.acciones.forEach(a => {
          html += `<div class="hia-timeline-item">
            <div class="sem">${a.semana}</div>
            <div>${a.accion}</div>
            <div class="resp">üìå ${a.responsable}</div>
          </div>`;
        });
        html += `</div>`;
      });
      html += `</div>`;

      // Detailed table
      html += `<div class="hia-card"><div class="hia-card-title">Detalle de Acciones por Mes</div>`;
      mesConfig.forEach(mc => {
        const mes = rm[mc.key];
        html += `<div style="font-weight:700;font-size:14px;margin:16px 0 8px;">${mc.icon} ${mes.titulo} (${mes.periodo})</div>
          <div class="hia-table-wrap"><table class="hia-table"><thead><tr><th>Semana</th><th>Acci√≥n</th><th>Responsable</th><th>Entregable</th></tr></thead><tbody>`;
        mes.acciones.forEach(a => {
          html += `<tr><td>${a.semana}</td><td>${a.accion}</td><td>${a.responsable}</td><td>${a.entregable}</td></tr>`;
        });
        html += `</tbody></table></div>`;
      });
      html += `</div>`;

      document.getElementById('secRoadmap').innerHTML = html;
    }

    // ‚îÄ‚îÄ SECTION 7: Governance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderGovernance() {
      const gov = CONFIG.governance;
      let html = `<div class="hia-section-title"><span class="icon" style="background:var(--hia-purple-light);color:var(--hia-purple);">üèõÔ∏è</span> Governance y Seguimiento</div>`;

      html += `<div class="hia-grid-2">
        <div class="hia-gov-card"><div class="hia-card-title">üìÖ Cadencia de Reuniones</div>
          <div class="hia-table-wrap"><table class="hia-table"><thead><tr><th>Reuni√≥n</th><th>Frecuencia</th><th>Participantes</th><th>Objetivo</th></tr></thead><tbody>`;
      gov.reuniones.forEach(r => {
        html += `<tr><td><strong>${r.nombre}</strong></td><td>${r.frecuencia}</td><td>${r.participantes}</td><td>${r.objetivo}</td></tr>`;
      });
      html += `</tbody></table></div></div>`;

      html += `<div class="hia-gov-card"><div class="hia-card-title">üë§ Due√±os por Hallazgo</div>
          <div class="hia-table-wrap"><table class="hia-table"><thead><tr><th>Hallazgo</th><th>Owner</th><th>Soporte</th><th>Escalamiento</th></tr></thead><tbody>`;
      gov.duenos.forEach(d => {
        html += `<tr><td><strong>${d.hallazgo}</strong></td><td>${d.owner}</td><td>${d.soporte}</td><td>${d.escalamiento}</td></tr>`;
      });
      html += `</tbody></table></div></div></div>`;

      html += `<div class="hia-card"><div class="hia-card-title">üìä Dashboard de Seguimiento Recomendado</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
          ${['Score promedio por semana (tendencia)','Distribuci√≥n de cuartiles (evoluci√≥n)','Errores fatales por semana (tendencia)','Agentes en riesgo (cantidad y progreso)','Avance de acciones (% completado)','Comparativo BPO/Canal/Skill (brechas)'].map((item,i) => `
            <div style="padding:14px;background:#f8fafc;border-radius:8px;border-left:3px solid var(--hia-purple);font-size:13px;">
              <span style="font-weight:700;color:var(--hia-purple);">${i+1}.</span> ${item}
            </div>`).join('')}
        </div></div>`;

      document.getElementById('secGovernance').innerHTML = html;
    }

    // ‚îÄ‚îÄ Toggle helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleHallazgo(id) {
      const el = document.getElementById(id);
      el.classList.toggle('open');
      setTimeout(notifyHeight, 100);
    }

    function switchLayer(hallazgoId, layer) {
      const parent = document.getElementById(hallazgoId);
      // Reset buttons
      parent.querySelectorAll('.hia-layer-btn').forEach(b => {
        b.className = 'hia-layer-btn';
      });
      // Activate button
      const btns = parent.querySelectorAll('.hia-layer-btn');
      const idx = layer === 'hallazgo' ? 0 : layer === 'insight' ? 1 : 2;
      btns[idx].classList.add(layer === 'hallazgo' ? 'active-hallazgo' : layer === 'insight' ? 'active-insight' : 'active-accion');
      // Toggle content
      parent.querySelectorAll('.hia-layer-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`${hallazgoId}-${layer}`).classList.add('active');
      setTimeout(notifyHeight, 50);
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COMMUNICATION WITH PARENT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function notifyHeight() {
      const height = document.body.scrollHeight;
      window.parent.postMessage({ type: 'RESIZE', height: height }, '*');
    }

    window.addEventListener('message', (event) => {
      if (event.data.type === 'FILTERED_DATA') {
        cargarPagina(event.data.data);
      }
    });

    if (window.parent.filteredData || window.parent.rawData) {
      cargarPagina(window.parent.filteredData || window.parent.rawData);
    }

    function cargarPagina(data) {
      if (!data || !data.base_excel) return;
      try {
        const colMap = buildColMap(data);
        const records = data.base_excel;
        const resultado = ejecutarAnalisis(records, colMap);
        renderPage(resultado);
        setTimeout(notifyHeight, 200);
        setTimeout(notifyHeight, 600);
        setTimeout(notifyHeight, 1200);
      } catch(e) {
        document.getElementById('contenidoPrincipal').innerHTML = `
          <div style="padding:40px;text-align:center;color:#ef4444;">
            <div style="font-size:20px;font-weight:700;margin-bottom:8px;">Error al procesar datos</div>
            <div style="font-size:13px;color:#64748b;">${e.message}</div>
          </div>`;
      }
    }
    </script>
</body>
</html>