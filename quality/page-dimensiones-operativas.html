<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desempe√±o por Dimensiones Operativas</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ===== ESTILOS LOCALES DE LA SUBP√ÅGINA ===== */

        /* Tabs de navegaci√≥n entre secciones */
        .dim-tabs {
            display: flex;
            gap: 4px;
            background: #f1f5f9;
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }
        .dim-tab {
            flex: 1;
            min-width: 140px;
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.25s ease;
            text-align: center;
        }
        .dim-tab:hover {
            color: #334155;
            background: rgba(255,255,255,0.6);
        }
        .dim-tab.active {
            background: #fff;
            color: #3b82f6;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .dim-section {
            display: none;
        }
        .dim-section.active {
            display: block;
        }

        /* Contenedores de contenido */
        .section-block {
            margin-bottom: 32px;
        }
        .section-block h3 {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }
        .section-block h3 span {
            font-size: 12px;
            font-weight: 400;
            color: #94a3b8;
            margin-left: 8px;
        }

        /* Grid de gr√°ficos lado a lado */
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        @media (max-width: 900px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        /* Contenedor de gr√°fico */
        .chart-box {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
        }
        .chart-box .chart-label {
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 12px;
        }

        /* Tablas mejoradas */
        .dim-table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }
        .dim-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 600px;
        }
        .dim-table thead {
            background: #f8fafc;
        }
        .dim-table th {
            padding: 10px 14px;
            text-align: left;
            font-weight: 700;
            color: #475569;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
        }
        .dim-table td {
            padding: 10px 14px;
            color: #334155;
            border-bottom: 1px solid #f1f5f9;
        }
        .dim-table tbody tr:hover {
            background: #f8fafc;
        }
        .dim-table .num {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }
        .dim-table .highlight-row {
            background: #eff6ff;
            font-weight: 600;
        }

        /* Badges de estado */
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }
        .status-badge.green {
            background: #dcfce7;
            color: #166534;
        }
        .status-badge.yellow {
            background: #fef9c3;
            color: #854d0e;
        }
        .status-badge.red {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Mini barras en celdas de tabla */
        .cell-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .cell-bar-track {
            flex: 1;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            min-width: 50px;
        }
        .cell-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease;
        }

        /* Heatmap */
        .heatmap-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
        }
        .heatmap-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .heatmap-table th {
            padding: 10px 14px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #475569;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
            text-align: center;
        }
        .heatmap-table th:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 2;
            background: #f8fafc;
        }
        .heatmap-table td {
            padding: 10px 14px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 1px solid #f1f5f9;
            min-width: 80px;
            transition: transform 0.15s;
        }
        .heatmap-table td:first-child {
            text-align: left;
            font-weight: 700;
            color: #334155;
            background: #fff;
            position: sticky;
            left: 0;
            z-index: 1;
            border-right: 1px solid #e2e8f0;
        }
        .heatmap-table tbody tr:hover td {
            opacity: 0.9;
        }
        .heatmap-total {
            font-weight: 700 !important;
            background: #f8fafc !important;
        }

        /* Secci√≥n Top/Bottom */
        .top-bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        @media (max-width: 900px) {
            .top-bottom-grid {
                grid-template-columns: 1fr;
            }
        }

        /* KPI resumen en cada secci√≥n */
        .dim-kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        .dim-kpi {
            background: #fff;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        .dim-kpi-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #94a3b8;
            margin-bottom: 6px;
        }
        .dim-kpi-value {
            font-size: 24px;
            font-weight: 800;
            color: #1e293b;
        }
        .dim-kpi-sub {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        /* Sin datos */
        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
            font-size: 14px;
        }

        /* Full width chart */
        .chart-full {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }
        .chart-full .chart-label {
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 12px;
        }
    </style>
</head>
<body style="background: transparent; padding: 0;">
    <div style="padding: 0;">
        <h2 style="margin-bottom: 24px; color: var(--text-primary, #1e293b);">Desempe√±o por Dimensiones Operativas</h2>

        <!-- Contenido principal -->
        <div id="contenidoPrincipal">
            <div class="loading">Cargando datos...</div>
        </div>
    </div>

    <script>
        // =============================================================
        // VARIABLES GLOBALES
        // =============================================================
        var chartInstances = [];

        // =============================================================
        // COMUNICACI√ìN CON P√ÅGINA PADRE
        // =============================================================

        function notifyHeight() {
            const height = document.body.scrollHeight;
            window.parent.postMessage({ type: 'RESIZE', height: height }, '*');
        }

        // =============================================================
        // UTILIDADES
        // =============================================================

        /** Agrupar registros por un campo */
        function groupBy(records, field) {
            return records.reduce((acc, r) => {
                const key = (r[field] || 'Sin especificar').toString().trim();
                if (!acc[key]) acc[key] = [];
                acc[key].push(r);
                return acc;
            }, {});
        }

        /** Agrupar por dos campos simult√°neamente */
        function groupBy2(records, field1, field2) {
            return records.reduce((acc, r) => {
                const k1 = (r[field1] || 'Sin especificar').toString().trim();
                const k2 = (r[field2] || 'Sin especificar').toString().trim();
                const key = `${k1}|||${k2}`;
                if (!acc[key]) acc[key] = [];
                acc[key].push(r);
                return acc;
            }, {});
        }

        /** Calcular promedio de un campo num√©rico */
        function avg(records, field) {
            const vals = records.map(r => parseFloat(r[field])).filter(v => !isNaN(v));
            return vals.length ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
        }

        /** Distribuci√≥n de cuartiles */
        function cuartilDist(records) {
            const total = records.length;
            if (!total) return { Q1: 0, Q2: 0, Q3: 0, Q4: 0 };
            const counts = { Q1: 0, Q2: 0, Q3: 0, Q4: 0 };
            records.forEach(r => {
                const c = (r['CUARTIL'] || '').toUpperCase().trim();
                if (counts.hasOwnProperty(c)) counts[c]++;
            });
            return {
                Q1: ((counts.Q1 / total) * 100),
                Q2: ((counts.Q2 / total) * 100),
                Q3: ((counts.Q3 / total) * 100),
                Q4: ((counts.Q4 / total) * 100)
            };
        }

        /** Porcentaje de cumplimiento de proceso */
        function pctCumplimiento(records) {
            const vals = records.map(r => parseFloat(r['CUMPLE PROCESO'])).filter(v => !isNaN(v));
            if (!vals.length) return 0;
            return (vals.filter(v => v === 1).length / vals.length) * 100;
        }

        /** Badge de estado por score */
        function statusBadge(score) {
            if (score >= 85) return `<span class="status-badge green">${score.toFixed(1)}</span>`;
            if (score >= 70) return `<span class="status-badge yellow">${score.toFixed(1)}</span>`;
            return `<span class="status-badge red">${score.toFixed(1)}</span>`;
        }

        /** Color para heatmap seg√∫n score */
        function heatColor(score) {
            if (isNaN(score) || score === null) return { bg: '#f8fafc', text: '#94a3b8' };
            if (score >= 90) return { bg: '#dcfce7', text: '#166534' };
            if (score >= 85) return { bg: '#d1fae5', text: '#065f46' };
            if (score >= 80) return { bg: '#e0f2fe', text: '#0c4a6e' };
            if (score >= 75) return { bg: '#fef9c3', text: '#854d0e' };
            if (score >= 70) return { bg: '#fed7aa', text: '#9a3412' };
            return { bg: '#fee2e2', text: '#991b1b' };
        }

        /** Paleta de colores para gr√°ficos */
        const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'];

        /** Ordenar semanas cronol√≥gicamente */
        function sortSemanas(a, b) {
            const na = parseInt(a.replace(/\D/g, '')) || 0;
            const nb = parseInt(b.replace(/\D/g, '')) || 0;
            return na - nb;
        }

        /** BPO dominante de un grupo */
        function bpoDominante(records) {
            const bpoCount = {};
            records.forEach(r => {
                const bpo = (r['BPO'] || 'N/A').trim();
                bpoCount[bpo] = (bpoCount[bpo] || 0) + 1;
            });
            let max = 0, dom = 'N/A';
            Object.entries(bpoCount).forEach(([k, v]) => {
                if (v > max) { max = v; dom = k; }
            });
            return dom;
        }

        // Guardar instancias de charts para destruirlas al recargar
        function destroyCharts() {
            if (chartInstances && chartInstances.length) {
                chartInstances.forEach(c => { try { c.destroy(); } catch(e) {} });
            }
            chartInstances = [];
        }

        // =============================================================
        // FUNCI√ìN PRINCIPAL
        // =============================================================

        function cargarPagina(data) {
            if (!data || !data.base_excel) return;
            destroyCharts();

            const records = data.base_excel;
            const container = document.getElementById('contenidoPrincipal');

            if (!records.length) {
                container.innerHTML = '<div class="no-data">No hay datos disponibles con los filtros seleccionados.</div>';
                setTimeout(notifyHeight, 100);
                return;
            }

            // =========================================================
            // Construir HTML
            // =========================================================
            let html = '';

            // --- TABS ---
            html += `
            <div class="dim-tabs">
                <button class="dim-tab active" data-tab="canal">üì° Canal</button>
                <button class="dim-tab" data-tab="skill">üéØ Skill</button>
                <button class="dim-tab" data-tab="subskill">üìÇ Sub-Skill</button>
                <button class="dim-tab" data-tab="monitoreo">üìã Tipo Monitoreo</button>
                <button class="dim-tab" data-tab="matriz">üó∫Ô∏è Matriz Cruzada</button>
            </div>`;

            // =======================================================
            // TAB 1: CANAL
            // =======================================================
            const canalGroup = groupBy(records, 'DATA_CANAL');
            const canales = Object.keys(canalGroup).sort();

            html += `<div class="dim-section active" id="sec-canal">`;
            html += `<div class="section-block"><h3>An√°lisis por Canal <span>${canales.length} canales ¬∑ ${records.length} auditor√≠as</span></h3>`;

            // KPIs r√°pidos
            const bestCanal = canales.reduce((best, c) => avg(canalGroup[c], 'QA SCORE') > avg(canalGroup[best], 'QA SCORE') ? c : best, canales[0]);
            html += `<div class="dim-kpis">
                <div class="dim-kpi"><div class="dim-kpi-label">Total Canales</div><div class="dim-kpi-value">${canales.length}</div></div>
                <div class="dim-kpi"><div class="dim-kpi-label">Mejor Canal</div><div class="dim-kpi-value" style="font-size:18px;">${bestCanal}</div><div class="dim-kpi-sub">Score: ${avg(canalGroup[bestCanal], 'QA SCORE').toFixed(1)}</div></div>
                <div class="dim-kpi"><div class="dim-kpi-label">Score Global</div><div class="dim-kpi-value">${avg(records, 'QA SCORE').toFixed(1)}</div></div>
                <div class="dim-kpi"><div class="dim-kpi-label">Cumplimiento Global</div><div class="dim-kpi-value">${pctCumplimiento(records).toFixed(1)}%</div></div>
            </div>`;

            // Tabla canal
            html += `<div class="dim-table-wrapper"><table class="dim-table"><thead><tr>
                <th>Canal</th><th class="num">Total</th><th class="num">Score Prom.</th>
                <th class="num">% Q1</th><th class="num">% Q2</th><th class="num">% Q3</th><th class="num">% Q4</th>
                <th class="num">% Cumplimiento</th>
            </tr></thead><tbody>`;
            canales.forEach(c => {
                const recs = canalGroup[c];
                const sc = avg(recs, 'QA SCORE');
                const cd = cuartilDist(recs);
                const cum = pctCumplimiento(recs);
                html += `<tr>
                    <td><strong>${c}</strong></td>
                    <td class="num">${recs.length}</td>
                    <td class="num">${statusBadge(sc)}</td>
                    <td class="num">${cd.Q1.toFixed(1)}%</td>
                    <td class="num">${cd.Q2.toFixed(1)}%</td>
                    <td class="num">${cd.Q3.toFixed(1)}%</td>
                    <td class="num">${cd.Q4.toFixed(1)}%</td>
                    <td class="num"><div class="cell-bar"><span>${cum.toFixed(1)}%</span><div class="cell-bar-track"><div class="cell-bar-fill" style="width:${cum}%;background:${cum>=80?'#10b981':cum>=60?'#f59e0b':'#ef4444'}"></div></div></div></td>
                </tr>`;
            });
            html += `</tbody></table></div>`;

            // Gr√°ficos de canal
            html += `<div class="charts-row">
                <div class="chart-box"><div class="chart-label">Score Promedio y Total Auditor√≠as por Canal</div><canvas id="chartCanalBars"></canvas></div>
                <div class="chart-box"><div class="chart-label">Tendencia Score por Canal (Semanas)</div><canvas id="chartCanalTrend"></canvas></div>
            </div>`;
            html += `</div></div>`;

            // =======================================================
            // TAB 2: SKILL
            // =======================================================
            const skillGroup = groupBy(records, 'DATA_SKILL');
            const skills = Object.keys(skillGroup).sort();

            html += `<div class="dim-section" id="sec-skill">`;
            html += `<div class="section-block"><h3>An√°lisis por Skill <span>${skills.length} skills</span></h3>`;

            const bestSkill = skills.reduce((best, s) => avg(skillGroup[s], 'QA SCORE') > avg(skillGroup[best], 'QA SCORE') ? s : best, skills[0]);
            html += `<div class="dim-kpis">
                <div class="dim-kpi"><div class="dim-kpi-label">Total Skills</div><div class="dim-kpi-value">${skills.length}</div></div>
                <div class="dim-kpi"><div class="dim-kpi-label">Mejor Skill</div><div class="dim-kpi-value" style="font-size:18px;">${bestSkill}</div><div class="dim-kpi-sub">Score: ${avg(skillGroup[bestSkill], 'QA SCORE').toFixed(1)}</div></div>
                <div class="dim-kpi"><div class="dim-kpi-label">Score Promedio</div><div class="dim-kpi-value">${avg(records, 'QA SCORE').toFixed(1)}</div></div>
            </div>`;

            // Tabla skill
            html += `<div class="dim-table-wrapper"><table class="dim-table"><thead><tr>
                <th>Skill</th><th class="num">Total</th><th class="num">Score Prom.</th>
                <th class="num">% Q1</th><th class="num">% Q2</th><th class="num">% Q3</th><th class="num">% Q4</th>
                <th>BPO Dominante</th>
            </tr></thead><tbody>`;
            skills.forEach(s => {
                const recs = skillGroup[s];
                const sc = avg(recs, 'QA SCORE');
                const cd = cuartilDist(recs);
                html += `<tr>
                    <td><strong>${s}</strong></td>
                    <td class="num">${recs.length}</td>
                    <td class="num">${statusBadge(sc)}</td>
                    <td class="num">${cd.Q1.toFixed(1)}%</td>
                    <td class="num">${cd.Q2.toFixed(1)}%</td>
                    <td class="num">${cd.Q3.toFixed(1)}%</td>
                    <td class="num">${cd.Q4.toFixed(1)}%</td>
                    <td>${bpoDominante(recs)}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;

            // Gr√°fico barras apiladas cuartiles
            html += `<div class="chart-full"><div class="chart-label">Distribuci√≥n de Cuartiles por Skill (Apiladas al 100%)</div><canvas id="chartSkillStacked"></canvas></div>`;
            html += `</div></div>`;

            // =======================================================
            // TAB 3: SUB-SKILL
            // =======================================================
            const subGroup = groupBy(records, 'DATA_SUB_SKILL');
            const subSkills = Object.keys(subGroup).sort((a, b) => avg(subGroup[b], 'QA SCORE') - avg(subGroup[a], 'QA SCORE'));

            html += `<div class="dim-section" id="sec-subskill">`;
            html += `<div class="section-block"><h3>An√°lisis por Sub-Skill <span>${subSkills.length} sub-skills</span></h3>`;

            // Tabla detallada sub-skill
            html += `<div class="dim-table-wrapper"><table class="dim-table"><thead><tr>
                <th>#</th><th>Sub-Skill</th><th>Skill Padre</th><th class="num">Total</th><th class="num">Score Promedio</th><th>Estado</th>
            </tr></thead><tbody>`;
            subSkills.forEach((ss, i) => {
                const recs = subGroup[ss];
                const sc = avg(recs, 'QA SCORE');
                // Buscar skill padre (valor m√°s frecuente de DATA_SKILL en este grupo)
                const skillPadre = bpoDominante(recs.map(r => ({ BPO: r['DATA_SKILL'] || 'N/A' })).map(x => ({ BPO: x.BPO })));
                const skillPadreReal = (() => {
                    const sp = {};
                    recs.forEach(r => {
                        const k = (r['DATA_SKILL'] || 'N/A').trim();
                        sp[k] = (sp[k] || 0) + 1;
                    });
                    let max = 0, dom = 'N/A';
                    Object.entries(sp).forEach(([k, v]) => { if (v > max) { max = v; dom = k; } });
                    return dom;
                })();
                const estado = sc >= 85 ? 'green' : sc >= 70 ? 'yellow' : 'red';
                const estadoText = sc >= 85 ? '√ìptimo' : sc >= 70 ? 'En riesgo' : 'Cr√≠tico';
                html += `<tr>
                    <td class="num" style="color:#94a3b8;">${i + 1}</td>
                    <td><strong>${ss}</strong></td>
                    <td>${skillPadreReal}</td>
                    <td class="num">${recs.length}</td>
                    <td class="num">${statusBadge(sc)}</td>
                    <td><span class="status-badge ${estado}">${estadoText}</span></td>
                </tr>`;
            });
            html += `</tbody></table></div>`;

            // Gr√°ficos Top 10 y Bottom 10
            html += `<div class="top-bottom-grid">
                <div class="chart-box"><div class="chart-label">üèÜ Top 10 Sub-Skills (Mayor Score)</div><canvas id="chartSubTop"></canvas></div>
                <div class="chart-box"><div class="chart-label">‚ö†Ô∏è Bottom 10 Sub-Skills (Menor Score)</div><canvas id="chartSubBottom"></canvas></div>
            </div>`;
            html += `</div></div>`;

            // =======================================================
            // TAB 4: TIPO DE MONITOREO
            // =======================================================
            const tipoGroup = groupBy(records, 'TIPO DE MONITOREO');
            const tipos = Object.keys(tipoGroup).sort();

            html += `<div class="dim-section" id="sec-monitoreo">`;
            html += `<div class="section-block"><h3>An√°lisis por Tipo de Monitoreo <span>${tipos.length} tipos</span></h3>`;

            html += `<div class="dim-kpis">`;
            tipos.forEach(t => {
                const sc = avg(tipoGroup[t], 'QA SCORE');
                const pct = ((tipoGroup[t].length / records.length) * 100).toFixed(1);
                html += `<div class="dim-kpi">
                    <div class="dim-kpi-label">${t}</div>
                    <div class="dim-kpi-value">${sc.toFixed(1)}</div>
                    <div class="dim-kpi-sub">${tipoGroup[t].length} auditor√≠as (${pct}%)</div>
                </div>`;
            });
            html += `</div>`;

            // Tabla tipo monitoreo
            html += `<div class="dim-table-wrapper"><table class="dim-table"><thead><tr>
                <th>Tipo de Monitoreo</th><th class="num">Total</th><th class="num">Score Promedio</th><th class="num">% del Total</th>
            </tr></thead><tbody>`;
            tipos.forEach(t => {
                const recs = tipoGroup[t];
                const sc = avg(recs, 'QA SCORE');
                const pct = (recs.length / records.length * 100);
                html += `<tr>
                    <td><strong>${t}</strong></td>
                    <td class="num">${recs.length}</td>
                    <td class="num">${statusBadge(sc)}</td>
                    <td class="num"><div class="cell-bar"><span>${pct.toFixed(1)}%</span><div class="cell-bar-track"><div class="cell-bar-fill" style="width:${pct}%;background:#3b82f6"></div></div></div></td>
                </tr>`;
            });
            html += `</tbody></table></div>`;

            // Gr√°fico donut
            html += `<div class="charts-row">
                <div class="chart-box"><div class="chart-label">Distribuci√≥n de Auditor√≠as por Tipo</div><canvas id="chartTipoDonut"></canvas></div>
                <div class="chart-box"><div class="chart-label">Score Promedio por Tipo de Monitoreo</div><canvas id="chartTipoBars"></canvas></div>
            </div>`;
            html += `</div></div>`;

            // =======================================================
            // TAB 5: MATRIZ CRUZADA (HEATMAP)
            // =======================================================
            html += `<div class="dim-section" id="sec-matriz">`;
            html += `<div class="section-block"><h3>Matriz Cruzada: Skill √ó Canal <span>Score promedio por celda</span></h3>`;

            // Construir heatmap
            const allCanales = [...new Set(records.map(r => (r['DATA_CANAL'] || 'Sin especificar').trim()))].sort();
            const allSkills = [...new Set(records.map(r => (r['DATA_SKILL'] || 'Sin especificar').trim()))].sort();
            const crossData = groupBy2(records, 'DATA_SKILL', 'DATA_CANAL');

            html += `<div class="heatmap-wrapper"><table class="heatmap-table"><thead><tr><th>Skill \\ Canal</th>`;
            allCanales.forEach(c => { html += `<th>${c}</th>`; });
            html += `<th style="background:#eef2ff;">PROMEDIO</th></tr></thead><tbody>`;

            allSkills.forEach(s => {
                html += `<tr><td>${s}</td>`;
                let skillScores = [];
                allCanales.forEach(c => {
                    const key = `${s}|||${c}`;
                    const recs = crossData[key];
                    if (recs && recs.length) {
                        const sc = avg(recs, 'QA SCORE');
                        skillScores.push(sc);
                        const color = heatColor(sc);
                        html += `<td style="background:${color.bg};color:${color.text};font-weight:700;" title="${s} / ${c}: ${recs.length} auditor√≠as">${sc.toFixed(1)}</td>`;
                    } else {
                        html += `<td style="background:#f8fafc;color:#cbd5e1;">‚Äî</td>`;
                    }
                });
                const skillAvg = skillScores.length ? (skillScores.reduce((a, b) => a + b, 0) / skillScores.length) : null;
                if (skillAvg !== null) {
                    const color = heatColor(skillAvg);
                    html += `<td class="heatmap-total" style="background:${color.bg};color:${color.text};">${skillAvg.toFixed(1)}</td>`;
                } else {
                    html += `<td class="heatmap-total">‚Äî</td>`;
                }
                html += `</tr>`;
            });

            // Fila de totales por canal
            html += `<tr style="border-top:2px solid #e2e8f0;"><td style="font-weight:700;background:#f8fafc;">PROMEDIO</td>`;
            let grandScores = [];
            allCanales.forEach(c => {
                const canalRecs = records.filter(r => (r['DATA_CANAL'] || '').trim() === c);
                if (canalRecs.length) {
                    const sc = avg(canalRecs, 'QA SCORE');
                    grandScores.push(sc);
                    const color = heatColor(sc);
                    html += `<td class="heatmap-total" style="background:${color.bg};color:${color.text};">${sc.toFixed(1)}</td>`;
                } else {
                    html += `<td class="heatmap-total">‚Äî</td>`;
                }
            });
            const grandAvg = grandScores.length ? (grandScores.reduce((a, b) => a + b, 0) / grandScores.length) : null;
            if (grandAvg !== null) {
                const color = heatColor(grandAvg);
                html += `<td class="heatmap-total" style="background:${color.bg};color:${color.text};font-size:15px;">${grandAvg.toFixed(1)}</td>`;
            } else {
                html += `<td class="heatmap-total">‚Äî</td>`;
            }
            html += `</tr></tbody></table></div>`;

            // Leyenda del heatmap
            html += `<div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;font-size:11px;color:#64748b;">
                <span>Leyenda:</span>
                <span style="display:inline-flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;border-radius:3px;background:#dcfce7;display:inline-block;"></span> ‚â• 90</span>
                <span style="display:inline-flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;border-radius:3px;background:#d1fae5;display:inline-block;"></span> 85-89</span>
                <span style="display:inline-flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;border-radius:3px;background:#e0f2fe;display:inline-block;"></span> 80-84</span>
                <span style="display:inline-flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;border-radius:3px;background:#fef9c3;display:inline-block;"></span> 75-79</span>
                <span style="display:inline-flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;border-radius:3px;background:#fed7aa;display:inline-block;"></span> 70-74</span>
                <span style="display:inline-flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;border-radius:3px;background:#fee2e2;display:inline-block;"></span> < 70</span>
            </div>`;

            html += `</div></div>`;

            // =========================================================
            // Renderizar HTML
            // =========================================================
            container.innerHTML = html;

            // =========================================================
            // Inicializar tabs
            // =========================================================
            document.querySelectorAll('.dim-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.dim-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.dim-section').forEach(s => s.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('sec-' + tab.dataset.tab).classList.add('active');
                    setTimeout(notifyHeight, 100);
                });
            });

            // =========================================================
            // GR√ÅFICOS
            // =========================================================

            // --- CANAL: Barras agrupadas (score + total) ---
            const ctxCanalBars = document.getElementById('chartCanalBars');
            if (ctxCanalBars) {
                const c1 = new Chart(ctxCanalBars, {
                    type: 'bar',
                    data: {
                        labels: canales,
                        datasets: [
                            {
                                label: 'Score Promedio',
                                data: canales.map(c => avg(canalGroup[c], 'QA SCORE')),
                                backgroundColor: '#3b82f6',
                                borderRadius: 6,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Total Auditor√≠as',
                                data: canales.map(c => canalGroup[c].length),
                                backgroundColor: '#e2e8f0',
                                borderRadius: 6,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } },
                        scales: {
                            y: { position: 'left', title: { display: true, text: 'Score', font: { size: 11 } }, min: 0, max: 100 },
                            y1: { position: 'right', title: { display: true, text: 'Auditor√≠as', font: { size: 11 } }, grid: { drawOnChartArea: false } }
                        }
                    }
                });
                chartInstances.push(c1);
            }

            // --- CANAL: Tendencia por semana ---
            const ctxCanalTrend = document.getElementById('chartCanalTrend');
            if (ctxCanalTrend) {
                const semanasByCanal = {};
                const allSemanas = new Set();
                canales.forEach(c => {
                    const byWeek = groupBy(canalGroup[c], 'SEMANA');
                    semanasByCanal[c] = byWeek;
                    Object.keys(byWeek).forEach(s => allSemanas.add(s));
                });
                const sortedSemanas = [...allSemanas].sort(sortSemanas);

                const datasets = canales.map((c, i) => ({
                    label: c,
                    data: sortedSemanas.map(s => semanasByCanal[c][s] ? avg(semanasByCanal[c][s], 'QA SCORE') : null),
                    borderColor: COLORS[i % COLORS.length],
                    backgroundColor: COLORS[i % COLORS.length] + '22',
                    tension: 0.3,
                    fill: false,
                    pointRadius: 3,
                    spanGaps: true
                }));

                const c2 = new Chart(ctxCanalTrend, {
                    type: 'line',
                    data: { labels: sortedSemanas, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } },
                        scales: {
                            y: { min: 0, max: 100, title: { display: true, text: 'Score Promedio', font: { size: 11 } } }
                        }
                    }
                });
                chartInstances.push(c2);
            }

            // --- SKILL: Barras apiladas 100% ---
            const ctxSkillStacked = document.getElementById('chartSkillStacked');
            if (ctxSkillStacked) {
                const cuartilColors = { Q1: '#10b981', Q2: '#3b82f6', Q3: '#f59e0b', Q4: '#ef4444' };
                const c3 = new Chart(ctxSkillStacked, {
                    type: 'bar',
                    data: {
                        labels: skills,
                        datasets: ['Q1', 'Q2', 'Q3', 'Q4'].map(q => ({
                            label: q,
                            data: skills.map(s => cuartilDist(skillGroup[s])[q]),
                            backgroundColor: cuartilColors[q],
                            borderRadius: 0
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { font: { size: 11 } } },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%`
                                }
                            }
                        },
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true, max: 100, title: { display: true, text: '% Distribuci√≥n', font: { size: 11 } } }
                        }
                    }
                });
                chartInstances.push(c3);
            }

            // --- SUB-SKILL: Top 10 ---
            const ctxSubTop = document.getElementById('chartSubTop');
            if (ctxSubTop) {
                const top10 = subSkills.slice(0, 10);
                const c4 = new Chart(ctxSubTop, {
                    type: 'bar',
                    data: {
                        labels: top10,
                        datasets: [{
                            label: 'Score',
                            data: top10.map(ss => avg(subGroup[ss], 'QA SCORE')),
                            backgroundColor: top10.map(ss => {
                                const sc = avg(subGroup[ss], 'QA SCORE');
                                return sc >= 85 ? '#10b981' : sc >= 70 ? '#f59e0b' : '#ef4444';
                            }),
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: { x: { min: 0, max: 100 } }
                    }
                });
                chartInstances.push(c4);
            }

            // --- SUB-SKILL: Bottom 10 ---
            const ctxSubBottom = document.getElementById('chartSubBottom');
            if (ctxSubBottom) {
                const bottom10 = [...subSkills].reverse().slice(0, 10);
                const c5 = new Chart(ctxSubBottom, {
                    type: 'bar',
                    data: {
                        labels: bottom10,
                        datasets: [{
                            label: 'Score',
                            data: bottom10.map(ss => avg(subGroup[ss], 'QA SCORE')),
                            backgroundColor: bottom10.map(ss => {
                                const sc = avg(subGroup[ss], 'QA SCORE');
                                return sc >= 85 ? '#10b981' : sc >= 70 ? '#f59e0b' : '#ef4444';
                            }),
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: { x: { min: 0, max: 100 } }
                    }
                });
                chartInstances.push(c5);
            }

            // --- TIPO MONITOREO: Donut ---
            const ctxTipoDonut = document.getElementById('chartTipoDonut');
            if (ctxTipoDonut) {
                const c6 = new Chart(ctxTipoDonut, {
                    type: 'doughnut',
                    data: {
                        labels: tipos,
                        datasets: [{
                            data: tipos.map(t => tipoGroup[t].length),
                            backgroundColor: tipos.map((_, i) => COLORS[i % COLORS.length]),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        cutout: '60%',
                        plugins: {
                            legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 12 } }
                        }
                    }
                });
                chartInstances.push(c6);
            }

            // --- TIPO MONITOREO: Barras score ---
            const ctxTipoBars = document.getElementById('chartTipoBars');
            if (ctxTipoBars) {
                const c7 = new Chart(ctxTipoBars, {
                    type: 'bar',
                    data: {
                        labels: tipos,
                        datasets: [{
                            label: 'Score Promedio',
                            data: tipos.map(t => avg(tipoGroup[t], 'QA SCORE')),
                            backgroundColor: tipos.map((_, i) => COLORS[i % COLORS.length]),
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { min: 0, max: 100, title: { display: true, text: 'Score', font: { size: 11 } } } }
                    }
                });
                chartInstances.push(c7);
            }

            // =========================================================
            // Notificar altura
            // =========================================================
            setTimeout(notifyHeight, 100);
            setTimeout(notifyHeight, 500);
            setTimeout(notifyHeight, 1000);
        }

        // =============================================================
        // INICIALIZACI√ìN (despu√©s de todas las declaraciones)
        // =============================================================
        window.addEventListener('message', (event) => {
            if (event.data.type === 'FILTERED_DATA') {
                cargarPagina(event.data.data);
            }
        });

        if (window.parent.filteredData || window.parent.rawData) {
            cargarPagina(window.parent.filteredData || window.parent.rawData);
        }
    </script>
</body>
</html>