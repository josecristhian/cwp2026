<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Calidad</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1 class="header-title">
                    Sistema de Monitoreo de Calidad
                    <button class="info-icon" id="infoIcon" title="Ver informaci√≥n del dataset">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M8 7v4M8 5v.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </button>
                </h1>
                
                <!-- Tooltip con informaci√≥n del dataset -->
                <div class="info-tooltip" id="infoTooltip">
                    <div class="tooltip-content">
                        <button class="tooltip-close" id="tooltipClose">√ó</button>
                        <h3>Informaci√≥n del Dataset</h3>
                        <div id="dataRangeInfo" class="tooltip-text">Cargando informaci√≥n...</div>
                    </div>
                </div>
            </div>
            
            <button class="filter-toggle" id="filterToggle">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M2.5 5.83333H17.5M5 10H15M7.5 14.1667H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Filtros
            </button>
        </header>

        <!-- Filtros Colapsables -->
        <div class="filters-container" id="filtersContainer" style="display: none;">
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="filterInteraccion">ID Interacci√≥n</label>
                    <input type="text" id="filterInteraccion" placeholder="Buscar ID...">
                </div>
                
                <div class="filter-group">
                    <label for="filterFechaInteraccionDesde">Fecha Interacci√≥n (Desde)</label>
                    <input type="date" id="filterFechaInteraccionDesde">
                </div>
                
                <div class="filter-group">
                    <label for="filterFechaInteraccionHasta">Fecha Interacci√≥n (Hasta)</label>
                    <input type="date" id="filterFechaInteraccionHasta">
                </div>
                
                <div class="filter-group">
                    <label for="filterTipoMonitoreo">Tipo de Monitoreo</label>
                    <select id="filterTipoMonitoreo">
                        <option value="">Todos</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterCanal">Canal</label>
                    <select id="filterCanal">
                        <option value="">Todos</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterSkill">Skill</label>
                    <select id="filterSkill">
                        <option value="">Todos</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterSubSkill">Sub-Skill</label>
                    <select id="filterSubSkill">
                        <option value="">Todos</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterBPO">BPO</label>
                    <select id="filterBPO">
                        <option value="">Todos</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterFechaMonitoreoDesde">Fecha Monitoreo (Desde)</label>
                    <input type="date" id="filterFechaMonitoreoDesde">
                </div>
                
                <div class="filter-group">
                    <label for="filterFechaMonitoreoHasta">Fecha Monitoreo (Hasta)</label>
                    <input type="date" id="filterFechaMonitoreoHasta">
                </div>
                
                <div class="filter-group">
                    <label for="filterAgente">Agente</label>
                    <select id="filterAgente">
                        <option value="">Todos</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterSupervisor">Supervisor</label>
                    <select id="filterSupervisor">
                        <option value="">Todos</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterAnalista">Analista</label>
                    <select id="filterAnalista">
                        <option value="">Todos</option>
                    </select>
                </div>
            </div>
            
            <div class="filter-actions">
                <button class="btn-secondary" id="clearFilters">Limpiar Filtros</button>
                <button class="btn-primary" id="applyFilters">Aplicar Filtros</button>
            </div>
        </div>

        <!-- Navigation Menu (cargado desde menu.html) -->
        <div id="menuContainer"></div>

        <!-- Content Area -->
        <main class="content" id="contentArea" style="min-height: auto; height: auto;">
            <!-- P√°gina de Bienvenida -->
            <div class="welcome-page">
                <div class="welcome-card">
                    <h2>Bienvenido al Sistema de Monitoreo de Calidad</h2>
                    <p class="welcome-subtitle">Panel de an√°lisis y seguimiento de interacciones</p>
                    
                    <div class="welcome-stats">
                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-content">
                                <div class="stat-value" id="totalInteracciones">-</div>
                                <div class="stat-label">Total Interacciones</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-content">
                                <div class="stat-value" id="totalAgentes">-</div>
                                <div class="stat-label">Agentes Monitoreados</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">‚≠ê</div>
                            <div class="stat-content">
                                <div class="stat-value" id="scorePromedio">-</div>
                                <div class="stat-label">Score Promedio</div>
                            </div>
                        </div>
                    </div>
                    
     
                </div>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        // Guardar el HTML original de la p√°gina de bienvenida
        let welcomePageHTML = '';
        
        // Funci√≥n para cargar el men√∫ desde archivo externo
        async function loadMenu() {
            try {
                const response = await fetch('menu.html');
                const html = await response.text();
                document.getElementById('menuContainer').innerHTML = html;
                
                // Inicializar el men√∫ despu√©s de cargarlo
                initializeMenu();
            } catch (error) {
                console.error('Error al cargar el men√∫:', error);
            }
        }
        
        // Inicializaci√≥n de la p√°gina principal
        document.addEventListener('DOMContentLoaded', async () => {
            // Cargar el men√∫ primero
            await loadMenu();
            
            // Guardar el contenido de bienvenida antes de cualquier modificaci√≥n
            welcomePageHTML = document.querySelector('.welcome-page').innerHTML;
            
            // Cargar datos
            await loadData();
            
            // Mostrar rango de fechas del dataset
            updateDataRangeInfo();
            
            // Event listeners para tooltip de informaci√≥n
            document.getElementById('infoIcon').addEventListener('click', (e) => {
                e.stopPropagation();
                const tooltip = document.getElementById('infoTooltip');
                tooltip.classList.toggle('show');
            });
            
            document.getElementById('tooltipClose').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('infoTooltip').classList.remove('show');
            });
            
            // Cerrar tooltip al hacer click fuera
            document.addEventListener('click', (e) => {
                const tooltip = document.getElementById('infoTooltip');
                const infoIcon = document.getElementById('infoIcon');
                if (!tooltip.contains(e.target) && e.target !== infoIcon) {
                    tooltip.classList.remove('show');
                }
            });
            
            // Inicializar filtros
            initializeFilters();
            
            // Actualizar estad√≠sticas de bienvenida
            updateWelcomeStats();
            
            // Guardar nuevamente despu√©s de actualizar stats
            welcomePageHTML = document.querySelector('.welcome-page').innerHTML;
            
            // Toggle de filtros
            document.getElementById('filterToggle').addEventListener('click', () => {
                const container = document.getElementById('filtersContainer');
                container.style.display = container.style.display === 'none' ? 'block' : 'none';
            });
            
            // Aplicar filtros
            document.getElementById('applyFilters').addEventListener('click', () => {
                const btn = document.getElementById('applyFilters');
                const originalText = btn.textContent;
                btn.textContent = 'Aplicando...';
                btn.disabled = true;
                
                applyFilters();
                
                // Recargar la p√°gina activa autom√°ticamente
                const activePage = getActiveMenuPage();
                if (activePage === 'bienvenida') {
                    // Actualizar estad√≠sticas de bienvenida
                    updateWelcomeStats();
                    btn.textContent = originalText;
                    btn.disabled = false;
                } else {
                    // Recargar la subp√°gina con los datos filtrados
                    loadPage(activePage);
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 500);
                }
            });
            
            // Limpiar filtros
            document.getElementById('clearFilters').addEventListener('click', () => {
                const btn = document.getElementById('clearFilters');
                const originalText = btn.textContent;
                btn.textContent = 'Limpiando...';
                btn.disabled = true;
                
                clearFilters();
                
                // Recargar la p√°gina activa autom√°ticamente
                const activePage = getActiveMenuPage();
                if (activePage === 'bienvenida') {
                    // Actualizar estad√≠sticas de bienvenida
                    updateWelcomeStats();
                    btn.textContent = originalText;
                    btn.disabled = false;
                } else {
                    // Recargar la subp√°gina con los datos filtrados
                    loadPage(activePage);
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 500);
                }
            });
        });
        
        function navigateToPage(page) {
            const contentArea = document.getElementById('contentArea');
            
            if (page === 'bienvenida') {
                // Restaurar p√°gina de bienvenida
                contentArea.innerHTML = '<div class="welcome-page">' + welcomePageHTML + '</div>';
                // Actualizar estad√≠sticas con datos actuales
                updateWelcomeStats();
            } else {
                // Cargar subp√°gina
                loadPage(page);
            }
        }
        
        function loadPage(page) {
            const iframe = document.createElement('iframe');
            // Agregar timestamp para evitar cache
            iframe.src = `page-${page}.html?v=${Date.now()}`;
            iframe.style.width = '100%';
            iframe.style.border = 'none';
            iframe.style.display = 'block';
            iframe.style.overflow = 'hidden';
            iframe.id = 'contentIframe';
            
            document.getElementById('contentArea').innerHTML = '';
            document.getElementById('contentArea').appendChild(iframe);
            
            // Escuchar mensajes de redimensionamiento
            window.addEventListener('message', function handleResize(event) {
                if (event.data.type === 'RESIZE' && event.data.height) {
                    const currentIframe = document.getElementById('contentIframe');
                    if (currentIframe) {
                        currentIframe.style.height = (event.data.height + 40) + 'px';
                    }
                }
            });
            
            // Ajustar altura del iframe autom√°ticamente
            iframe.onload = () => {
                function resizeIframe() {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        const height = iframeDoc.body.scrollHeight;
                        iframe.style.height = (height + 40) + 'px';
                    } catch (e) {
                        // Fallback si hay problemas de acceso
                        iframe.style.height = '1200px';
                    }
                }
                
                resizeIframe();
                
                // Pasar datos filtrados al iframe cuando cargue
                iframe.contentWindow.postMessage({
                    type: 'FILTERED_DATA',
                    data: window.filteredData || window.rawData
                }, '*');
                
                // Re-ajustar despu√©s de que se carguen los datos
                setTimeout(resizeIframe, 300);
                setTimeout(resizeIframe, 800);
                setTimeout(resizeIframe, 1500);
            };
        }
        
        function updateWelcomeStats() {
            const data = window.filteredData || window.rawData;
            if (!data || !data.base_excel) return;
            
            const totalInteracciones = data.base_excel.length;
            const agentesUnicos = new Set(data.base_excel.map(r => r.AGENTE)).size;
            const scorePromedio = (data.base_excel.reduce((sum, r) => sum + (parseFloat(r['QA SCORE']) || 0), 0) / totalInteracciones).toFixed(1);
            
            const totalEl = document.getElementById('totalInteracciones');
            const agentesEl = document.getElementById('totalAgentes');
            const scoreEl = document.getElementById('scorePromedio');
            
            if (totalEl) totalEl.textContent = totalInteracciones.toLocaleString();
            if (agentesEl) agentesEl.textContent = agentesUnicos.toLocaleString();
            if (scoreEl) scoreEl.textContent = scorePromedio + '%';
        }
        
        function updateDataRangeInfo() {
            const data = window.rawData;
            if (!data || !data.base_excel || data.base_excel.length === 0) return;
            
            // Formatear opciones para fechas en espa√±ol
            const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
            
            // === FECHAS DE MONITOREO ===
            const fechasMonitoreo = data.base_excel
                .map(r => window.parseDate(r['FECHA DE MONITOREO']))
                .filter(d => d !== null)
                .sort((a, b) => a - b);
            
            const monitoreoMasAntiguo = fechasMonitoreo[0];
            const monitoreoMasReciente = fechasMonitoreo[fechasMonitoreo.length - 1];
            
            // === FECHAS DE INTERACCI√ìN ===
            const fechasInteraccion = data.base_excel
                .map(r => window.parseDate(r['FECHA DE INTERACCI√ìN']))
                .filter(d => d !== null)
                .sort((a, b) => a - b);
            
            const interaccionMasAntigua = fechasInteraccion[0];
            const interaccionMasReciente = fechasInteraccion[fechasInteraccion.length - 1];
            
            // === √öLTIMOS MONITOREOS POR BPO ===
            // Filtrar por KN
            const registrosKN = data.base_excel.filter(r => r.BPO === 'KN');
            const fechasKN = registrosKN
                .map(r => window.parseDate(r['FECHA DE MONITOREO']))
                .filter(d => d !== null)
                .sort((a, b) => b - a); // Descendente
            const ultimoMonitoreoKN = fechasKN[0];
            
            // Filtrar por AT
            const registrosAT = data.base_excel.filter(r => r.BPO === 'AT');
            const fechasAT = registrosAT
                .map(r => window.parseDate(r['FECHA DE MONITOREO']))
                .filter(d => d !== null)
                .sort((a, b) => b - a); // Descendente
            const ultimoMonitoreoAT = fechasAT[0];
            
            // === CONSTRUIR MENSAJE HTML ===
            let html = '<div class="info-section">';
            
            if (monitoreoMasAntiguo && monitoreoMasReciente) {
                html += `
                    <div class="info-item">
                        <strong>üìÖ Datos de Monitoreo</strong>
                        <div>Desde ${monitoreoMasAntiguo.toLocaleDateString('es-ES', opciones)}</div>
                        <div>Hasta ${monitoreoMasReciente.toLocaleDateString('es-ES', opciones)}</div>
                    </div>
                `;
            }
            
            if (interaccionMasAntigua && interaccionMasReciente) {
                html += `
                    <div class="info-item">
                        <strong>üìû Datos de Interacciones</strong>
                        <div>Desde ${interaccionMasAntigua.toLocaleDateString('es-ES', opciones)}</div>
                        <div>Hasta ${interaccionMasReciente.toLocaleDateString('es-ES', opciones)}</div>
                    </div>
                `;
            }
            
            html += '<div class="info-item"><strong>üè¢ √öltimos Monitoreos por BPO</strong>';
            
            if (ultimoMonitoreoKN) {
                html += `<div>KN: ${ultimoMonitoreoKN.toLocaleDateString('es-ES', opciones)}</div>`;
            }
            
            if (ultimoMonitoreoAT) {
                html += `<div>AT: ${ultimoMonitoreoAT.toLocaleDateString('es-ES', opciones)}</div>`;
            }
            
            html += '</div></div>';
            
            const infoElement = document.getElementById('dataRangeInfo');
            if (infoElement) {
                infoElement.innerHTML = html;
            }
        }
        
        function initializeMenu() {
            console.log('Inicializando men√∫...');
            
            // Click en items de men√∫ principales
            document.querySelectorAll('.menu-item').forEach(item => {
                const label = item.querySelector('.menu-label');
                
                if (!label) return;
                
                label.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    console.log('Click en menu item:', item.dataset.page, 'Has submenu:', item.classList.contains('has-submenu'));
                    
                    // Si tiene submen√∫, toggle del submen√∫
                    if (item.classList.contains('has-submenu')) {
                        const wasOpen = item.classList.contains('open');
                        
                        // Cerrar todos los submen√∫s
                        document.querySelectorAll('.menu-item.open').forEach(i => {
                            i.classList.remove('open');
                        });
                        
                        // Toggle el actual
                        if (!wasOpen) {
                            item.classList.add('open');
                            console.log('Submen√∫ abierto');
                        } else {
                            console.log('Submen√∫ cerrado');
                        }
                    } else {
                        // Cerrar todos los submen√∫s
                        document.querySelectorAll('.menu-item.open').forEach(i => {
                            i.classList.remove('open');
                        });
                        
                        // Navegar directamente
                        const page = item.dataset.page;
                        if (page) {
                            setActiveMenuItem(item);
                            navigateToPage(page);
                        }
                    }
                });
            });
            
            // Click en items de submen√∫
            document.querySelectorAll('.submenu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const page = item.dataset.page;
                    console.log('Click en submenu item:', page);
                    
                    if (page) {
                        const parentItem = item.closest('.menu-item');
                        setActiveMenuItem(parentItem);
                        setActiveSubmenuItem(item);
                        navigateToPage(page);
                        
                        // Cerrar el submen√∫
                        parentItem.classList.remove('open');
                    }
                });
            });
            
            // Cerrar submen√∫s al hacer click fuera
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.menu-item')) {
                    document.querySelectorAll('.menu-item.open').forEach(i => {
                        i.classList.remove('open');
                    });
                }
            });
            
            // Marcar bienvenida como activo por defecto
            const firstItem = document.querySelector('.menu-item[data-page="bienvenida"]');
            if (firstItem) {
                setActiveMenuItem(firstItem);
            }
            
            console.log('Men√∫ inicializado. Total items:', document.querySelectorAll('.menu-item').length);
        }
        
        function setActiveMenuItem(item) {
            // Remover active de todos
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            // Agregar active al seleccionado
            item.classList.add('active');
        }
        
        function setActiveSubmenuItem(item) {
            // Remover active de todos los subitems
            document.querySelectorAll('.submenu-item').forEach(i => i.classList.remove('active'));
            // Agregar active al seleccionado
            item.classList.add('active');
        }
        
        function getActiveMenuPage() {
            // Primero buscar en submenu items activos
            const activeSubitem = document.querySelector('.submenu-item.active');
            if (activeSubitem && activeSubitem.dataset.page) {
                return activeSubitem.dataset.page;
            }
            
            // Luego buscar en menu items activos
            const activeItem = document.querySelector('.menu-item.active');
            if (activeItem && activeItem.dataset.page) {
                return activeItem.dataset.page;
            }
            
            return 'bienvenida';
        }
    </script>
</body>
</html>